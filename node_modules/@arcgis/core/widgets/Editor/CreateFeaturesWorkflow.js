/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
import{_ as e}from"../../chunks/tslib.es6.js";import t from"../../Graphic.js";import{remove as a}from"../../core/arrayUtils.js";import i from"../../core/Error.js";import{makeHandle as r,handlesGroup as s}from"../../core/handleUtils.js";import"../../core/has.js";import{removeMaybe as n,destroyMaybe as o}from"../../core/maybe.js";import{debounce as l}from"../../core/promiseUtils.js";import{watch as d,initial as c,syncAndInitial as h,whenOnce as p}from"../../core/reactiveUtils.js";import{generateBracedUUID as u}from"../../core/uuid.js";import{property as f}from"../../core/accessorSupport/decorators/property.js";import"../../core/Logger.js";import{subclass as m}from"../../core/accessorSupport/decorators/subclass.js";import g from"../../layers/GraphicsLayer.js";import{isTable as w}from"../../layers/support/layerUtils.js";import{getDrawHelpMessage as y}from"../../views/draw/support/helpMessageUtils.js";import{ViewEventPriorities as v}from"../../views/input/InputManager.js";import _ from"../../views/interactive/sketch/SketchOptions.js";import M from"../../views/interactive/snapping/FeatureSnappingLayerSource.js";import{CreateFeaturesWorkflowData as F}from"./CreateFeaturesWorkflowData.js";import{isModelUpload as b,handleModelUpload as I}from"./modelUploadUtils.js";import k from"./Workflow.js";import{startCreatingNewFeature as V,findLayerInfo as A,updateGraphicSymbolWhenRequired as H,isTerminalUpdateEventType as S,getVisualVariableAttributes as C,startUpdatingFeature as j,createWorkflowSteps as O,avoidFeatureTemplateSelectionWithOnlyOneItem as U,prepareAttachmentsForCreateFeaturesWorkflow as E,showProgressCursor as D,visualVariableInteractiveUpdate as G}from"./workflowUtils.js";import P from"../FeatureForm/FeatureFormViewModel.js";import L from"../Sketch/SketchViewModel.js";var T;const W=Symbol(),x=Symbol(),N=Symbol();let z=T=class extends k{constructor(e){super(e),this.type="create-features",this.createFeatureState="create-new",this.data=void 0,this.isNested=!1,this._getDrawMeshHelpMessage=void 0,this._featureFormHandle=null,this._visualVariableAttributes={rotation:null,size:null},this._featureFormViewModel=new P,this._sketchViewModel=null,this._attachmentFileInfos=new Map,this._highlightHandles=new Map,this._preventDefaultActionOnCancel=!1,this._lastActiveGraphics=[],this._isActive=!0,this._updateGraphicDebounced=l(((e,t,a)=>H(e,t,a)))}initialize(){this.isNested&&(this._isActive=!1),this._initializeSketchViewModel()}destroy(){this._sketchViewModel.destroy()}get featureFormViewModel(){return this._featureFormViewModel}get hasPendingEdits(){if(this.numPendingFeatures>0)return!0;const{creationInfo:e,upload:t}=this.data,a=this._sketchViewModel,{activeComponent:i}=a,r=a.createGraphic?.geometry?.type;return!("polyline"!==r&&"polygon"!==r&&"multipoint"!==r||"draw-2d"!==i?.type&&"draw-3d"!==i?.type)&&i.drawOperation.committedVertices.length>0||(!(!t||"pending"!==t.state&&"success"!==t.state)||!!e?.geometryToPlace)}get helpMessage(){const{creationInfo:e,viewModel:t}=this.data;if("creating-features"!==this.stepId||!e)return;const a=e.layer.geometryType,i=this._sketchViewModel.createGraphic;if("mesh"===a){this._getDrawMeshHelpMessage||import("../../views/draw/support/helpMessageUtils3d.js").then((e=>{this._getDrawMeshHelpMessage=e.getDrawMeshHelpMessage}));const{view:e}=t;return"3d"===e?.type?this._getDrawMeshHelpMessage?.(i,e):void 0}return y(a,i?.geometry)}get layer(){return this.data.creationInfo?.layer}get numPendingFeatures(){return this.pendingFeatures.length}get parent(){return this.data.parent}get parentLayer(){return this.parent?.data.editorItem.layer}get pendingFeatures(){return this.data.pendingFeatures}get keyboardCancellationEnabled(){return 0===this.numPendingFeatures}get reliesOnOwnerAdminPrivileges(){return this.data.editorItem?.capabilities.create.reliesOnOwnerAdminPrivileges??!1}get shouldShowAttachments(){return this.data.editorItem?.capabilities.create.attachments.enabled??!1}get shouldAllowAttachmentEditing(){return this.shouldShowAttachments}get sketchViewModel(){return this._sketchViewModel}get test(){}async enter(){this._isActive=!0,"awaiting-feature-creation-info"!==this.stepId&&this._setUpCreatingFeaturesStep()}exit(){this._isActive=!1,this.removeHandles([N])}async updatePendingFeature(e,t){return this._preventDefaultActionOnCancel=!0,this._sketchViewModel.cancel(),a(this._lastActiveGraphics,e),this._startUpdating(e,t)}async start(){return await super.start(),w(this.data.creationInfo?.layer)?null:{enter:async()=>{},exit:async()=>{},viewModel:this._sketchViewModel}}static create(e){const{addAttachmentsCallback:t,applyEditsCallback:a,isNested:i,creationInfo:r,parent:s,snappingManager:n,startAt:o,viewModel:l}=e,d=e.sketchOptions??new _,c=r?.layer,h=c?l.findEditorItemForLayer(c):void 0,p=new T({data:new F({creationInfo:r,editorItem:h,parent:s,sketchOptions:d,snappingManager:n,viewModel:l}),isNested:i,onCommit:async e=>{const{creationInfo:i}=e;if(!i)return;const r=e.pendingFeatures.toArray(),{layer:s}=i,n=s.capabilities?.editing.supportsGlobalId&&"globalIdField"in s,o=p._attachmentFileInfos;if(n){const e=q(r,s,o);return void await a(s,e,{globalIdUsed:!0})}const l=await a(s,{addFeatures:r});if(o.size>0){const e=l?.addFeatureResults??[];await t(s,Z(r,e,s,o))}}});return p._set("steps",this._createWorkflowSteps(p,o)),p}_fadeExistingFeatures(e){if("effect"in e){const t=e.effect;return e.effect="saturate(0.6) opacity(0.8)",r((()=>e.effect=t))}const t=e.opacity;return e.opacity=.7,r((()=>e.opacity=t))}_highlight(e){const t=this.data.viewModel.view;"3d"===t?.type&&this._highlightHandles.set(e,t.highlight(e))}_removeHighlight(e){n(this._highlightHandles.get(e)),this._highlightHandles.delete(e)}async _startCreating(e){this.removeHandles(x);const{creationInfo:t}=this.data;if(!t)return;this.createFeatureState="create-new";const a=await V(this._sketchViewModel,t,e);this.addHandles(a,x)}async _startUpdating(e,t){const{pendingFeatures:a}=this;a.includes(e)||a.add(e);const{_featureFormViewModel:i,_sketchViewModel:r}=this,{creationInfo:o,viewModel:l}=this.data,{attachmentsViewModel:c,layerInfos:h,view:p}=l;if(!p||!o)return;const u=o.layer,f=A(h,u),m=f?.formTemplate,g=p.spatialReference;i.set({arcadeEditType:"INSERT",feature:e,formTemplate:m,spatialReference:g,map:p.map}),"add"!==c.mode&&"edit"!==c.mode||l.activeWorkflow?.previous(),c.graphic=e,c.fileInfos.removeAll(),c.mode="view";if((this._attachmentFileInfos.get(e)||[]).forEach((({file:e,form:t})=>c.addFile(e,t))),this._removeHighlight(e),await H(e,t,"2d"===p.type?p.scale:null),this.removeHandles(x),n(this._featureFormHandle),"2d"===p.type){const a=d((()=>p.scale),(a=>this._updateGraphicDebounced(e,t,a)));this.addHandles(a,x)}return this._featureFormHandle=s([i.on("value-change",(async()=>{e.attributes=i.getValues(),await H(e,t,"2d"===p.type?p.scale:null)})),r.on(["update","undo","redo"],(e=>{("undo"===e.type||"redo"===e.type||"update"===e.type&&null!=e.toolEventInfo&&S(e.toolEventInfo.type))&&i.notifyFeatureGeometryChanged()}))]),this.createFeatureState="update-pending",this._visualVariableAttributes=C(e),w(u)?void 0:j({graphic:e,sketchViewModel:r,sourceLayer:u,visualVariables:this._visualVariableAttributes,webStyleCache:t})}static _createWorkflowSteps(e,t="awaiting-feature-creation-info"){const{data:a}=e,i=O(["awaiting-feature-creation-info","creating-features","adding-attachment","editing-attachment"],t,{"awaiting-feature-creation-info":()=>({id:"awaiting-feature-creation-info",async setUp(){const{creationInfo:t,viewModel:i}=a,{view:r}=i;r&&(b(t)?e.addHandles(await I({view:r,data:a,next:()=>e.next(),cancel:()=>i.cancelWorkflow({warnIfNoWorkflow:!1})}),this.id):(a.parent&&t&&(e.addHandles(i.lockFeatureTemplatesViewModel(),this.id),i.featureTemplatesViewModel.layers=[t.layer]),e.addHandles(i.featureTemplatesViewModel.on("select",(({item:t})=>{t&&(a.creationInfo={...a.creationInfo,layer:t.layer,template:t.template},e.next())})),this.id)))},async tearDown(){e.removeHandles([this.id,x])}}),"creating-features":()=>({id:"creating-features",async setUp(){e._isActive&&await e._setUpCreatingFeaturesStep()},async tearDown(t){const{viewModel:i}=a;t.canceled&&(e.removeHandles([N,W,x]),i.attachmentsViewModel.fileInfos.removeAll(),e._attachmentFileInfos.clear())}}),"adding-attachment":()=>({id:"adding-attachment",parent:"creating-features",async setUp(){},async tearDown(){const{attachmentsViewModel:t}=a.viewModel,{graphic:i,fileInfos:r}=t;e._attachmentFileInfos.set(i,r.toArray()),t.mode="view"}}),"editing-attachment":()=>({id:"editing-attachment",parent:"creating-features",async setUp(){},async tearDown(){const{attachmentsViewModel:t}=a.viewModel,{graphic:i,fileInfos:r}=t;e._attachmentFileInfos.set(i,r.toArray()),t.mode="view"}})});return U(a,i)}static _configureSketchViewModel(e,t){const{data:i}=e,{creationInfo:n,viewModel:o}=i,{view:l}=o,d=e._sketchViewModel;let c=null;const h=[];if(!l)return r();"2d"===l.type&&n&&h.push(e._fadeExistingFeatures(n.layer));const u=async a=>{if("cancel"===a.state){if(e._preventDefaultActionOnCancel)return void(e._preventDefaultActionOnCancel=!1);if(e._lastActiveGraphics.length<1)return e._startCreating(t);const a=e._lastActiveGraphics.pop();return e._startUpdating(a,t)}if("complete"===a.state&&a.graphic)return e._startUpdating(a.graphic,t)},f=async a=>{const{attachmentsViewModel:i}=o,{_featureFormViewModel:r}=e,s=a.graphics[0];if("complete"===a.state){s!==c&&(e._lastActiveGraphics.push(s),e._highlight(s)),c=null;const{hasPendingSubtypeChoice:d,submittable:h}=r;if(e.numPendingFeatures===n?.maxFeatures||d||!h){!h&&r.submit();const a=e._lastActiveGraphics.pop();return e._startUpdating(a,t)}if("add"!==i.mode&&"edit"!==i.mode||o.activeWorkflow?.previous(),a.aborted&&e._preventDefaultActionOnCancel)return void(e._preventDefaultActionOnCancel=!1);e.addHandles([D(l),l.on("click",(e=>e.preventDefault()))],W),await p((()=>!r.updating)),e.removeHandles(W),e._startCreating(t)}"start"===a.state&&e._removeHighlight(s);const d=e._visualVariableAttributes;await G(l,s,a,d,t);const h=s.attributes,{rotation:u,size:f}=d;if(null!=u){const{field:e}=u;r.setValue(e,h[e])}if(null!=f){const{field:e}=f;r.setValue(e,h[e])}},m=t=>{const i=t.graphics[0];e.pendingFeatures.remove(i),a(e._lastActiveGraphics,i),c=i},g=async a=>{if(b(n))return;const{results:i}=await l.hitTest(a,{include:d.layer}),r=i.find((e=>"graphic"===e.type&&e.graphic.sourceLayer===n?.layer));if(!r)return;const s=r.graphic;if("transform"===d.activeTool||"reshape"===d.activeTool){if(d.updateGraphics.at(0)===s)return;const{submittable:a,hasPendingSubtypeChoice:i}=e._featureFormViewModel;if(!a||i)return;await e.updatePendingFeature(s,t)}};h.push(d.on("create",(t=>e._updatingHandles.addPromise(u(t)))),d.on("update",(t=>e._updatingHandles.addPromise(f(t)))),d.on("delete",(e=>m(e))),l.on("immediate-click",(t=>e._updatingHandles.addPromise(g(t))),v.TOOL),r((()=>{e._preventDefaultActionOnCancel=!0,d.cancel()})),R(d,i));const w=s(h);return d.addHandles(w),w}_initializeSketchViewModel(){const{data:e}=this,{view:t}=e.viewModel,a=new g({elevationInfo:e.creationInfo?.layer.elevationInfo,internal:!0,listMode:"hide"}),i=new L({layer:a,sketchOptions:e.sketchOptions,snappingManager:e.snappingManager,updateOnGraphicClick:!1,view:t});this._sketchViewModel=i,t?.map.add(a),this.addHandles(r((()=>{t?.destroyed||t?.map.remove(a),a.destroy()})))}async _setUpCreatingFeaturesStep(){if(this.hasHandles(N))return;const{creationInfo:e,viewModel:a}=this.data,{attachmentsViewModel:o,view:l}=a;if(!l||!e?.layer)throw new i("missing-parameters","CreateFeaturesWorkflow requires a view and creationInfo.");const{initialFeature:h,layer:p}=e,u=this._sketchViewModel,f=new Map,m=[];this._lastActiveGraphics=[],this._featureFormHandle=n(this._featureFormHandle),this._visualVariableAttributes={rotation:null,size:null},this.data.editorItem=a.findEditorItemForLayer(e.layer),E(o),m.push(d((()=>o.mode),(e=>{switch(e){case"add":this.go("adding-attachment");break;case"edit":this.go("editing-attachment")}})));const g=D(l);m.push(g);const y=w(e.layer);try{if(y){const a=h??new t({attributes:{...e.template?.prototype.attributes,...e.attributeOverrides},sourceLayer:p});await this._startUpdating(a,f)}else m.push(T._configureSketchViewModel(this,f)),h?(u.layer.add(h),await this._startUpdating(h,f)):await this._startCreating(f)}finally{g.remove()}const v=r((()=>this.pendingFeatures.drain((e=>u.layer.remove(e))))),_=d((()=>l?.timeZone),(e=>this._featureFormViewModel.timeZone=e),c),M=r((()=>{b(e)&&a.cancelWorkflow({warnIfNoWorkflow:!1})}));this._featureFormHandle&&m.push(this._featureFormHandle),this.addHandles(m,this._handleKeys.beforeCommit),this.addHandles([r((()=>o.fileInfos.removeAll())),s(m),M,v,_],N)}};function R(e,t){let a=null;const i=()=>e.snappingOptions.featureSources,n=()=>(a=new M({layer:e.layer}),i().add(a),a),l=()=>{null!=a&&(i().remove(a),a=o(a))};return s([d((()=>{const e=t.creationInfo?.layer,a=i().find((t=>t.layer===e));return{hasFeatureLayerSource:!!a,enabled:a?.enabled??!1}}),(({hasFeatureLayerSource:e,enabled:t})=>{if(!e)return l();a??=n(),a.enabled=t}),h),r(l)])}function Z(e,t,a,i){const r=[];return t.forEach(((t,s)=>{if(!t.error){const n=e[s],o=i.get(n)||[];n.attributes[a.objectIdField]=t.objectId,o.forEach((({form:e})=>r.push({feature:n,attachment:e})))}})),r}function q(e,t,a){const i=[],r=t.globalIdField;return e.forEach(((t,s)=>{e[s].attributes[r]??=u(),(a?.get(t)||[]).forEach((({file:e})=>i.push({feature:t,attachment:{globalId:u(),data:e}})))})),i.length?{addFeatures:e,addAttachments:i}:{addFeatures:e}}e([f()],z.prototype,"createFeatureState",void 0),e([f()],z.prototype,"data",void 0),e([f({constructOnly:!0})],z.prototype,"isNested",void 0),e([f()],z.prototype,"featureFormViewModel",null),e([f()],z.prototype,"hasPendingEdits",null),e([f()],z.prototype,"_getDrawMeshHelpMessage",void 0),e([f()],z.prototype,"helpMessage",null),e([f()],z.prototype,"layer",null),e([f()],z.prototype,"parent",null),e([f()],z.prototype,"parentLayer",null),e([f()],z.prototype,"keyboardCancellationEnabled",null),e([f()],z.prototype,"reliesOnOwnerAdminPrivileges",null),e([f()],z.prototype,"shouldShowAttachments",null),e([f()],z.prototype,"shouldAllowAttachmentEditing",null),e([f()],z.prototype,"sketchViewModel",null),z=T=e([m("esri.widgets.Editor.CreateFeaturesWorkflow")],z);const K=z;export{K as default};
