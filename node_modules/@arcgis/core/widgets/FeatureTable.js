/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
import{_ as e}from"../chunks/tslib.es6.js";import"../intl.js";import t from"../core/Collection.js";import{watch as i,sync as l,initial as o,on as s}from"../core/reactiveUtils.js";import{property as n}from"../core/accessorSupport/decorators/property.js";import"../core/has.js";import"../core/Logger.js";import"../core/RandomLCG.js";import{subclass as r}from"../core/accessorSupport/decorators/subclass.js";import{isLayerFromCatalog as a}from"../layers/catalog/catalogUtils.js";import{isKnowledgeGraphLayer as d}from"../layers/support/layerUtils.js";import c from"./Widget.js";import h from"./FeatureTable/ColumnMenuVisibleElements.js";import p from"./FeatureTable/FeatureTableViewModel.js";import m from"./FeatureTable/VisibleElements.js";import u from"./FeatureTable/support/FieldColumnTemplate.js";import b from"./FeatureTable/support/TableTemplate.js";import{isIFeatureTableSupportedLayer as g,uniqueColumnNames as w,isIFeatureTableSupportedLayerWithAttachments as v,isMapImageLayer as y}from"./FeatureTable/support/tableUtils.js";import{loadCalciteComponents as f}from"./support/componentsUtils.js";import{globalCss as _}from"./support/globalCss.js";import{Heading as M}from"./support/Heading.js";import{renderingSanitizer as E}from"./support/widgetUtils.js";import{messageBundle as C}from"./support/decorators/messageBundle.js";import{vmEvent as T}from"./support/decorators/vmEvent.js";import{tsx as S}from"./support/jsxFactory.js";import{substitute as I}from"../intl/substitute.js";var A;const R="esri-feature-table",j=`${R}__prompt`,k={base:R,content:`${R}__content`,menuPopover:`${R}__menu-popover`,layerDropdownMenu:`${R}__layer-switcher-menu`,tableContainer:`${R}__table-container`,tableNavigation:`${R}__table-navigation`,expanded:`${R}__expanded`,collapsed:`${R}__collapsed`,promptContainer:j,promptHeader:`${j}__header`,promptHeading:`${j}__header__heading`,promptMessage:`${j}__message`,promptDivider:`${j}__divider`,promptActions:`${j}__actions`},F={clearSelection:"clear-selection",delete:"trash",refresh:"refresh",showAll:"selection-x",showSelected:"selection-filter",zoomToSelection:"zoom-to-object"};let D=A=class extends c{constructor(e,i){super(e,i),this._columnVisibilityActions=new Map,this._prompt=null,this._showAllTablesEnabled=!1,this.description=null,this.disabled=!1,this.layers=null,this.menuConfig=null,this.relatedTables=new t,this.tableParent=null,this.title=null,this.viewModel=new p,this.visibleElements=new m,this.visibleElementsOverride=null,this._showDeletePrompt=this._showDeletePrompt.bind(this),this._onDeleteSelectionClick=this._onDeleteSelectionClick.bind(this)}initialize(){this.addHandles([i((()=>[this.viewModel.store.querying,this.viewModel.store.syncing,this.editingEnabled]),(()=>this.scheduleRender())),i((()=>({visibleElements:this._effectiveVisibleElements,items:this.columns.length})),(({visibleElements:e})=>{this.columns.forEach((t=>t.visibleElements=e)),this.refreshCellContent()}),l),i((()=>this._effectiveVisibleElements.selectionColumn),(e=>{this.grid&&(this.grid.selectionColumnEnabled=e)}),o),s((()=>this.viewModel),"show-related-table",(e=>this._onShowRelatedTable(e))),i((()=>this.viewModel.state),(e=>{"disabled"===e&&this.relatedTables.length&&this._drainRelatedTables()}))])}loadDependencies(){return f({action:()=>import("@esri/calcite-components/dist/components/calcite-action.js"),button:()=>import("@esri/calcite-components/dist/components/calcite-button.js"),dropdown:()=>import("@esri/calcite-components/dist/components/calcite-dropdown.js"),"dropdown-group":()=>import("@esri/calcite-components/dist/components/calcite-dropdown-group.js"),"dropdown-item":()=>import("@esri/calcite-components/dist/components/calcite-dropdown-item.js"),icon:()=>import("@esri/calcite-components/dist/components/calcite-icon.js"),label:()=>import("@esri/calcite-components/dist/components/calcite-label.js"),list:()=>import("@esri/calcite-components/dist/components/calcite-list.js"),"list-item":()=>import("@esri/calcite-components/dist/components/calcite-list-item.js"),panel:()=>import("@esri/calcite-components/dist/components/calcite-panel.js"),popover:()=>import("@esri/calcite-components/dist/components/calcite-popover.js"),progress:()=>import("@esri/calcite-components/dist/components/calcite-progress.js"),scrim:()=>import("@esri/calcite-components/dist/components/calcite-scrim.js"),switch:()=>import("@esri/calcite-components/dist/components/calcite-switch.js"),tooltip:()=>import("@esri/calcite-components/dist/components/calcite-tooltip.js"),"action-bar":()=>import("@esri/calcite-components/dist/components/calcite-action-bar.js"),"input-date-picker":()=>import("@esri/calcite-components/dist/components/calcite-input-date-picker.js"),"input-time-picker":()=>import("@esri/calcite-components/dist/components/calcite-input-time-picker.js"),"input-time-zone":()=>import("@esri/calcite-components/dist/components/calcite-input-time-zone.js")})}destroy(){this._drainRelatedTables(),this._clearPrompt()}get _effectiveDescription(){const{description:e}=this;return null!=e?E.sanitize("function"==typeof e?e():e):void 0}get _effectiveLayers(){const{layer:e,layers:t}=this,i=t?.length?t.filter(g):[],l=i.length?i:[...this._viewLayers];return e&&!l.includes(e)&&l.push(e),l}get _effectiveTable(){return this.relatedTable||this}get _effectiveTitle(){const{layer:e,messages:t,state:i,highlightIds:l,title:o,viewModel:s}=this;if(o)return E.sanitize("function"==typeof o?o():o);if(!e)return t.noLayer;switch(i){case"disabled":return t.errorLayer;case"ready":case"loading":return t.loading;case"error":return t.errorData}return I(t.header,{title:E.sanitize(e.title),count:s.size,selected:l.length})}get _effectiveVisibleElements(){return this.visibleElementsOverride??this.visibleElements}get _hasCustomMenuItems(){return!!this.menuConfig?.items?.length}get _hasDefaultMenuItems(){return!!(this._showClearSelectionAction||this._showDeleteSelectionAction||this._showRefreshDataAction||this._showZoomToSelectionAction||this._showSelectedRecordsShowSelectedAction||this._showSelectedRecordsShowAllAction||this._showColumnsVisibilityAction)}get _shouldShowMenu(){const{header:e,menu:t}=this._effectiveVisibleElements;return!(!e||!t||!this._hasDefaultMenuItems&&!this._hasCustomMenuItems)}get _showClearSelectionAction(){return!(!this.highlightIds.length||!this._effectiveVisibleElements.menuItems?.clearSelection||this.relatedTables.length)}get _showColumnsVisibilityAction(){const{header:e,menu:t,menuItems:i}=this._effectiveVisibleElements;return!(!(e&&t&&i?.toggleColumns)||this.showRelatedTableCallback||this._showAllTablesEnabled)}get _showDeleteSelectionAction(){return!(!(this.editingEnabled&&this.highlightIds.length&&this._effectiveVisibleElements.menuItems?.deleteSelection&&this.layer?.capabilities?.operations?.supportsDelete)||this.relatedTables.length)}get _showLayerDropdown(){return!(!this._effectiveLayers.length||!this._effectiveVisibleElements.layerDropdown)}get _showRefreshDataAction(){return!!this._effectiveVisibleElements.menuItems?.refreshData}get _showSelectedRecordsShowSelectedAction(){const e=this.objectIds.length,t=this.highlightIds.length;return!(!t||!this._effectiveVisibleElements.menuItems?.selectedRecordsShowSelectedToggle||e&&t===e||this.relatedTables.length)}get _showSelectedRecordsShowAllAction(){return!(!this._effectiveVisibleElements.menuItems?.selectedRecordsShowAllToggle||!this.objectIds.length||this.relatedTables.length)}get _showZoomToSelectionAction(){return!(!this.view||!this.highlightIds.length||this._effectiveTable.layer?.isTable||!this._effectiveVisibleElements.menuItems?.zoomToSelection)}get _viewLayers(){const e=this.view?.map;if(!e)return[];const t=new Set,i=e=>{g(e)&&!t.has(e)&&t.add(e)},l=e=>{a(e)||"catalog-footprint"===e.type||(d(e)?(e.layers?.forEach(i),e.tables?.forEach(i)):y(e)?(e.sublayers?.forEach(i),e.subtables?.forEach(i)):i(e))};return e.allLayers.forEach(l),e.allTables.forEach(l),[...t.values()]}get actionColumnConfig(){return this.viewModel.actionColumnConfig}set actionColumnConfig(e){this.viewModel.actionColumnConfig=e}get activeFilters(){return this.viewModel.activeFilters}get activeSortOrders(){return this.viewModel.activeSortOrders}get attachmentsEnabled(){return this.viewModel.attachmentsEnabled}set attachmentsEnabled(e){this.viewModel.attachmentsEnabled=e}get autoRefreshEnabled(){return this.viewModel.autoRefreshEnabled}set autoRefreshEnabled(e){this.viewModel.autoRefreshEnabled=e}get columnPerformanceModeEnabled(){return this.viewModel.columnPerformanceModeEnabled}set columnPerformanceModeEnabled(e){this.viewModel.columnPerformanceModeEnabled=e}get columnReorderingEnabled(){return this.viewModel.columnReorderingEnabled}set columnReorderingEnabled(e){this.viewModel.columnReorderingEnabled=e}get columns(){return this.viewModel.columns}get editingEnabled(){return this.viewModel.editingEnabled}set editingEnabled(e){this.viewModel.editingEnabled=e}get filterGeometry(){return this.viewModel.filterGeometry}set filterGeometry(e){this.viewModel.filterGeometry=e}get filterBySelectionEnabled(){return this.viewModel.filterBySelectionEnabled}set filterBySelectionEnabled(e){this.viewModel.filterBySelectionEnabled=e}get grid(){return this.viewModel.grid}get hiddenFields(){return this.viewModel.hiddenFields}set hiddenFields(e){this.viewModel.hiddenFields=e}get highlightEnabled(){return this.viewModel.highlightEnabled}set highlightEnabled(e){this.viewModel.highlightEnabled=e}get highlightIds(){return this.viewModel.highlightIds}set highlightIds(e){this.viewModel.highlightIds=e}get icon(){return"table"}set icon(e){this._overrideIfSome("icon",e)}get isQueryingOrSyncing(){return this.viewModel.isQueryingOrSyncing||this.relatedTables.some((e=>!!e.isQueryingOrSyncing))}get label(){return this.messages?.widgetLabel??""}set label(e){this._overrideIfSome("label",e)}get layer(){return this.viewModel.layer}set layer(e){this._drainRelatedTables(),this.viewModel.layer=e}get layerView(){return this.viewModel.layerView}get messages(){return this.viewModel.messages}set messages(e){this.viewModel.messages=e}get messagesCommon(){return this.viewModel.messagesCommon}set messagesCommon(e){this.viewModel.messagesCommon=e}get messagesURIUtils(){return this.viewModel.messagesURIUtils}set messagesURIUtils(e){this.viewModel.messagesURIUtils=e}get multipleSelectionEnabled(){return this.viewModel.multipleSelectionEnabled}set multipleSelectionEnabled(e){this.viewModel.multipleSelectionEnabled=e}get multiSortEnabled(){return this.viewModel.multiSortEnabled}set multiSortEnabled(e){this.viewModel.multiSortEnabled=e}get objectIds(){return this.viewModel.objectIds}set objectIds(e){this.viewModel.objectIds=e}get pageSize(){return this.viewModel.pageSize}set pageSize(e){this.viewModel.pageSize=e}get relatedRecordsEnabled(){return this.viewModel.relatedRecordsEnabled}set relatedRecordsEnabled(e){this.viewModel.relatedRecordsEnabled=e}get relatedTable(){return this.relatedTables.at(-1)}get relationship(){return this.viewModel.relationship}get relationshipColumnConfigs(){return this.viewModel.relationshipColumnConfigs}set relationshipColumnConfigs(e){this.viewModel.relationshipColumnConfigs=e}get relationshipConfig(){return this.viewModel.relationshipConfig}set relationshipConfig(e){this.viewModel.relationshipConfig=e}get returnGeometryEnabled(){return this.viewModel.returnGeometryEnabled}set returnGeometryEnabled(e){this.viewModel.returnGeometryEnabled=e}get returnMEnabled(){return this.viewModel.returnMEnabled}set returnMEnabled(e){this.viewModel.returnMEnabled=e}get returnZEnabled(){return this.viewModel.returnZEnabled}set returnZEnabled(e){this.viewModel.returnZEnabled=e}get rowHighlightIds(){return this.viewModel.rowHighlightIds}set rowHighlightIds(e){this.viewModel.rowHighlightIds=e}get selectionSource(){return this.viewModel.selectionSource}set selectionSource(e){this.viewModel.selectionSource=e}get showRelatedTableCallback(){return this.viewModel.showRelatedTableCallback}set showRelatedTableCallback(e){this.viewModel.showRelatedTableCallback=e}get size(){return this.viewModel.size}get state(){return this.viewModel.state}get tableTemplate(){return this.viewModel.tableTemplate}set tableTemplate(e){this.viewModel.tableTemplate=e}get tableTemplateOverride(){return this.viewModel.tableTemplateOverride}set tableTemplateOverride(e){this.viewModel.tableTemplateOverride=e}get timeExtent(){return this.viewModel.timeExtent}set timeExtent(e){this.viewModel.timeExtent=e}get timeZone(){return this.viewModel.timeZone}set timeZone(e){this.viewModel.timeZone=e}get view(){return this.viewModel.view}set view(e){this.viewModel.view=e}clearSelectionFilter(){this.viewModel.clearSelectionFilter()}deleteSelection(e){return this.highlightIds.length?e?(this._showDeletePrompt(),this.scheduleRender(),Promise.resolve()):this.viewModel.deleteSelection():Promise.resolve()}filterBySelection(){this.viewModel.filterBySelection()}findColumn(e){return this.viewModel.findColumn(e)}hideColumn(e){this.grid?.hideColumn(e)}async refresh(){this.relatedTables.forEach((async e=>await e.refresh())),await this.viewModel.refresh()}refreshCellContent(){this.viewModel.refreshCellContent()}showAllColumns(){this.viewModel.showAllColumns()}showColumn(e){this.grid?.showColumn(e)}sortColumn(e,t){this.viewModel.sortColumn(e,t)}scrollToIndex(e){this.viewModel.scrollToIndex(e)}toggleColumnVisibility(e){this.viewModel.toggleColumnVisibility(e)}zoomToSelection(){this._effectiveTable.viewModel.zoomToSelection()}render(){const{_prompt:e,_effectiveVisibleElements:t,isQueryingOrSyncing:i,menuConfig:l,state:o}=this;return S("div",{bind:this,class:this.classes(k.base,_.widget)},S("calcite-panel",{bind:this,class:k.content,closable:t.close,description:this._effectiveDescription,disabled:this.disabled||"disabled"===o,heading:t.header?this._effectiveTitle:void 0,loading:"loading"===o,menuOpen:!!l?.open,overlayPositioning:"fixed",onCalcitePanelClose:e=>{e.target.closed=!1,this.emit("close")}},t.progress?S("calcite-progress",{type:i?"indeterminate":"determinate"}):null,this._showLayerDropdown?this._renderLayerDropdown():null,this._renderColumnVisibilityAction(),this._renderHeaderMenuActions(),this._renderRelatedTableNavigationBar(),S("div",{class:k.tableContainer},this._renderTables())),e?S("calcite-scrim",null,this._renderPrompt(e)):null)}_renderTables(){const{_showAllTablesEnabled:e,grid:t,relatedTables:i}=this;if(i.length){const l=i.toArray(),o=1===l.length,s=this.classes(k.base,e?k.expanded:k.collapsed),n=e||o,r=e?l:o?[l[0]]:l.slice(-2);return S("calcite-panel",{overlayPositioning:"fixed"},S("div",null,[n?S("div",{class:s},t?.render()):void 0,...r.map((e=>{const t=i.indexOf(e);return S("div",{class:s,key:`related-${t}`},e.render())})),,]))}return t?.render()}_clearPrompt(){this._prompt=null}_renderPrompt({title:e,message:t,context:i,actions:l}){const o=S("calcite-button",{appearance:"solid",key:"prompt-primary-button",kind:"danger"===i?"danger":"brand",onclick:l.primary.action,width:l.secondary?"half":"full"},l.primary.label),s=l.secondary?S("calcite-button",{appearance:"outline",key:"prompt-secondary-button",kind:"danger"===i?"danger":"brand",onclick:l.secondary.action,width:"half"},l.secondary.label):null;return S("div",{class:`${k.promptContainer}--${i}`},S("div",{class:k.promptHeader},S("calcite-icon",{icon:"exclamation-mark-triangle"}),S(M,{class:k.promptHeading,level:2},e)),S("div",{class:k.promptMessage},t),S("div",{class:k.promptDivider}),S("div",{class:k.promptActions},s,o))}_showDeletePrompt(){const{messages:e,messagesCommon:t}=this,i=I(e.deleteSelectionCount,{count:this.highlightIds.length});this._prompt={title:i,message:e.deleteRecordsRemoved,context:"danger",actions:{primary:{label:t.delete,action:this._onDeleteSelectionClick},secondary:{label:e.keepRecords,action:()=>this._clearPrompt()}}}}async _onDeleteSelectionClick(){try{await this.viewModel.deleteSelection()}finally{this._clearPrompt()}}_renderHeaderMenuAction(e){const{disabled:t,hidden:i,icon:l,text:o,clickFunction:s}=e;if(!i)return S("calcite-action",{disabled:t??this.menuConfig?.disabled,icon:l??void 0,key:o,onclick:()=>s(),slot:"header-menu-actions",text:o,textEnabled:!0,title:o})}_renderHeaderMenuActions(){return this._shouldShowMenu?[this._renderDefaultHeaderMenuActions(),this._renderCustomHeaderMenuActions()]:[]}_renderDefaultHeaderMenuActions(){if(!this._hasDefaultMenuItems)return[];const{messages:e}=this,t=[];return this._showRefreshDataAction&&t.push(this._renderHeaderMenuAction({icon:F.refresh,text:e.refreshData,clickFunction:()=>this.refresh()})),this._showDeleteSelectionAction&&t.push(this._renderHeaderMenuAction({icon:F.delete,text:e.deleteSelection,clickFunction:()=>this.deleteSelection(!0)})),this._showClearSelectionAction&&t.push(this._renderHeaderMenuAction({icon:F.clearSelection,text:e.clearSelection,clickFunction:()=>this.highlightIds?.removeAll()})),this._showZoomToSelectionAction&&t.push(this._renderHeaderMenuAction({icon:F.zoomToSelection,text:e.zoomToSelection,clickFunction:()=>this.zoomToSelection()})),this._showSelectedRecordsShowSelectedAction&&t.push(this._renderHeaderMenuAction({icon:F.showSelected,text:e.showSelected,clickFunction:()=>{const{objectIds:e}=this;e.removeAll(),e.addMany(this.highlightIds.toArray())}})),this._showSelectedRecordsShowAllAction&&t.push(this._renderHeaderMenuAction({icon:F.showAll,text:e.showAllRecords,clickFunction:()=>this.objectIds.removeAll()})),t}_renderCustomHeaderMenuActions(){return this.menuConfig?.items?.map((({disabled:e,hidden:t,icon:i,label:l,clickFunction:o})=>this._renderHeaderMenuAction({hidden:"function"==typeof t?t():t,icon:i,text:l,disabled:e,clickFunction:e=>o(e)})))??[]}_renderColumnVisibilityAction(){if(!this._showColumnsVisibilityAction)return[];const{_columnVisibilityActions:e,_effectiveTable:t,_effectiveVisibleElements:i,id:l,messages:o}=this,s=t.columns.toArray(),n=o?.toggleColumns,r=`${l}__toggle-columns-action`,a=[S("calcite-action",{afterCreate:t=>e.set(l,t),afterRemoved:()=>e.delete(l),appearance:"transparent",bind:this,disabled:t.menuConfig?.disabled,icon:"show-column",id:r,slot:"header-actions-end",text:n},i.tooltips?S("calcite-tooltip",{closeOnClick:!0,overlayPositioning:"fixed",placement:"bottom-end",slot:"tooltip"},n):null)];return t.menuConfig?.disabled||a.push(S("calcite-popover",{autoClose:!0,class:k.menuPopover,label:n,overlayPositioning:"fixed",placement:"top-end",pointerDisabled:!0,referenceElement:e.get(l)},S("calcite-list",{filterEnabled:!0,filterPlaceholder:o.toggleColumns,selectionMode:"multiple"},...s.map((e=>{const i="columns"in e&&e.columns?.length?e.columns.map((e=>this._renderColumnListItem({column:e,table:t,ignoreSelect:!0}))):void 0;return this._renderColumnListItem({column:e,table:t,items:i})}))))),a}_renderColumnListItem(e){const{column:t,table:i,items:l,ignoreSelect:o}=e,{effectiveLabel:s,fieldName:n,hidden:r}=t;return S("calcite-list-item",{key:`toggle-columns__item-${n}`,label:s,open:!(!l?.length||r)||void 0,selected:!r,value:n,onCalciteListItemSelect:e=>{o||i.toggleColumnVisibility(e.target.value)}},l)}_renderLayerDropdown(){const e=this.messages.selectALayer;return S("div",{class:k.layerDropdownMenu,key:`${this.id}-layerDropdown`,slot:"header-actions-start"},S("calcite-dropdown",{bind:this,maxItems:5,overlayPositioning:"fixed",placement:"bottom-start"},S("calcite-action",{icon:"layers",slot:"trigger",text:e,title:e}),S("calcite-dropdown-group",{selectionMode:"single"},this._effectiveLayers.map(((e,t)=>this._renderLayerDropdownItem(e,t)))??null)))}_renderLayerDropdownItem(e,t){return S("calcite-dropdown-item",{key:`dropdown-item-${t}`,label:e.title??"",selected:e===this.layer,value:e.id,onCalciteDropdownItemSelect:()=>{this.layer=e}},e.title)}_onShowRelatedTable(e){this.showRelatedTableCallback||(this._collapseRelatedTable(this._effectiveTable,e),this._createRelatedTable(e))}_renderRelatedTableNavigationBar(){const{messages:e}=this,t=e.exitRelatedRecords;if(this.relatedTables.length&&!this.showRelatedTableCallback)return S("div",{class:k.tableNavigation,key:"table-nav"},S("calcite-action",{icon:"move-up",iconFlipRtl:!0,key:t,onclick:()=>this._drainRelatedTables(),text:t,title:t}),this.relatedTables.toArray().map(((e,t)=>this._renderRelatedTableNavigationAction(e,t))),S("div",null,S("calcite-label",{layout:"inline"},e.showAllTables,S("calcite-switch",{checked:this._showAllTablesEnabled,onCalciteSwitchChange:e=>{const t=!!e.target.checked,i=this.relatedTable;this._showAllTablesEnabled=t,i&&(t?this._enterShowAllView(i):this._exitShowAllView(i))}}))))}_renderRelatedTableNavigationAction(e,t){const i=this._getLabelForRelatedTableNavigationAction(e);return S("calcite-action",{icon:"chevron-right",iconFlipRtl:!0,key:t,onclick:()=>this._drainRelatedTablesAboveIndex(t),text:i,textEnabled:!0,title:e.layer?.title||""})}_getLabelForRelatedTableNavigationAction(e){const t=e.layer?.title;if(!t)return"";const{relatedTables:i}=this;if(i.length<=1)return t;return i.indexOf(e)!==i.length-1&&t.length>20?`${t.slice(0,20)}...`:t}_drainRelatedTables(){this.relatedTables.drain((e=>!e.destroyed&&e.destroy())),this.set({_showAllTablesEnabled:!1,multipleSelectionEnabled:!0,tableTemplateOverride:null,relationshipColumnConfigs:null,visibleElementsOverride:null}),this.hiddenFields.removeMany([w.action,w.attachments])}_drainRelatedTablesAboveIndex(e){const t=this.relatedTables,i=t.filter(((t,i)=>i>e));i.forEach((e=>!e.destroyed&&e.destroy())),t.removeMany(i);const l=t.at(-1);if(!l?.layer||!l?.relationship)return;const{layer:o,relationship:s}=l;this._showAllTablesEnabled?this._enterShowAllView(l):l.set({multipleSelectionEnabled:!0,tableTemplateOverride:null,relationshipColumnConfigs:this._getRelationshipIdsToShow(o,s.id),visibleElementsOverride:null}),l.hiddenFields.removeMany([w.action,w.attachments])}_getRelatedTableMenuItemConfig(e,t,i){return t.fields.map((({alias:l,name:o})=>({selected:o===i,label:l||o,clickFunction:i=>{i.stopPropagation(),e.tableTemplateOverride=new b({columnTemplates:[this._createRelatedFieldColumnTemplate(e,t,o)]})}})))}_createRelatedFieldColumnTemplate(e,t,i){return new u({fieldName:i,editable:!1,menuConfig:{selectionMode:"single",icon:"chevron-down",items:this._getRelatedTableMenuItemConfig(e,t,i)},resizable:!1})}_enterShowAllView(e){const t=e.layer;if(!t)return;const i=e===this,{visibleElements:l}=e,o=t.displayField||t.objectIdField;e.set({relationshipColumnConfigs:[],tableTemplateOverride:new b({columnTemplates:[this._createRelatedFieldColumnTemplate(e,t,o)]}),visibleElementsOverride:new m({header:i&&l.header,progress:i&&l.progress,columnMenus:l.columnMenus,close:l.close,tooltips:l.tooltips,selectionColumn:!1,columnMenuItems:new h({sortAscending:!1,sortDescending:!1})})}),e.hiddenFields.addMany([w.action,w.attachments])}_exitShowAllView(e){const{layer:t,relationship:i}=e;t&&null!=i?.id&&(e.set({relationshipColumnConfigs:this._getRelationshipIdsToShow(t,i.id),tableTemplateOverride:null,visibleElementsOverride:null}),e.hiddenFields.removeMany([w.action,w.attachments]))}_collapseRelatedTable(e,i){const{relatedLayer:l,feature:o,relationshipId:s}=i,n=l.relationships?.find((({id:e})=>e===s)),{objectIdField:r}=l,a=l.displayField||n?.keyField||r,d=o.getObjectId()??o.attributes[r],c=e===this,{close:p,columnMenus:u,header:g,layerDropdown:v,menu:y,menuItems:f,progress:_,tooltips:M}=e.visibleElements;e.set({highlightIds:new t([d]),multipleSelectionEnabled:!1,relationshipColumnConfigs:[{relationshipId:s,collapsed:!0}],tableTemplateOverride:new b({columnTemplates:[this._createRelatedFieldColumnTemplate(e,l,a)]}),visibleElementsOverride:new m({header:c&&g,progress:c&&_,columnMenus:u,close:p,layerDropdown:v,menu:y,menuItems:f,tooltips:M,selectionColumn:!1,columnMenuItems:new h({sortAscending:!1,sortDescending:!1})})}),e.hiddenFields.addMany([w.action,w.attachments]),e.grid?.scrollLeft(0)}_getRelationshipIdsToShow(e,t){return(e.relationships??[]).filter((e=>!(e.id===t&&"one-to-one"===e.cardinality))).map((({id:e})=>({relationshipId:e})))}async _createRelatedTable(e){const{editingEnabled:t,relatedTables:i,view:l,viewModel:o}=this,{layer:n,feature:r,relatedLayer:a,relationshipId:d}=e,c=r.getObjectId()??r.attributes[a.objectIdField],h=i.length,p=h?i.getItemAt(h-1):this;await n.load();const u=this.attachmentsEnabled&&v(n),b=new A({layer:n,attachmentsEnabled:u,editingEnabled:t,relatedRecordsEnabled:!0,relationshipConfig:{objectId:c,relatedLayer:a,relationshipId:d},relationshipColumnConfigs:this._getRelationshipIdsToShow(n,d),tableParent:p,view:l,visibleElements:new m({header:!1,progress:!1}),showRelatedTableCallback:({feature:e,layer:t,relatedLayer:i,relationshipId:l})=>{null!=(e.getObjectId()??e.attributes[i.objectIdField])&&o.emit("show-related-table",{feature:e,layer:t,relatedLayer:i,relationshipId:l})}});b.addHandles([s((()=>p.highlightIds),"change",(({added:e})=>{const t=e[0];null!=t&&(b.highlightIds.removeAll(),b.relationshipConfig={objectId:t,relatedLayer:a,relationshipId:d})})),s((()=>p),"cell-click",(e=>{const{feature:t}=e;if(t){const e=t.getObjectId()??t.attributes[a.objectIdField];null!=e&&p.highlightIds.add(e)}}))]),this.relatedTables.add(b),this.scheduleRender()}};e([n()],D.prototype,"_columnVisibilityActions",void 0),e([n()],D.prototype,"_effectiveDescription",null),e([n()],D.prototype,"_effectiveLayers",null),e([n()],D.prototype,"_effectiveTable",null),e([n()],D.prototype,"_effectiveTitle",null),e([n()],D.prototype,"_effectiveVisibleElements",null),e([n()],D.prototype,"_hasCustomMenuItems",null),e([n()],D.prototype,"_hasDefaultMenuItems",null),e([n()],D.prototype,"_prompt",void 0),e([n()],D.prototype,"_shouldShowMenu",null),e([n()],D.prototype,"_showAllTablesEnabled",void 0),e([n()],D.prototype,"_showClearSelectionAction",null),e([n()],D.prototype,"_showColumnsVisibilityAction",null),e([n()],D.prototype,"_showDeleteSelectionAction",null),e([n()],D.prototype,"_showLayerDropdown",null),e([n()],D.prototype,"_showRefreshDataAction",null),e([n()],D.prototype,"_showSelectedRecordsShowSelectedAction",null),e([n()],D.prototype,"_showSelectedRecordsShowAllAction",null),e([n()],D.prototype,"_showZoomToSelectionAction",null),e([n()],D.prototype,"_viewLayers",null),e([n()],D.prototype,"actionColumnConfig",null),e([n({readOnly:!0})],D.prototype,"activeFilters",null),e([n({readOnly:!0})],D.prototype,"activeSortOrders",null),e([n()],D.prototype,"attachmentsEnabled",null),e([n()],D.prototype,"autoRefreshEnabled",null),e([n()],D.prototype,"columnPerformanceModeEnabled",null),e([n()],D.prototype,"columnReorderingEnabled",null),e([n({readOnly:!0})],D.prototype,"columns",null),e([n()],D.prototype,"description",void 0),e([n()],D.prototype,"disabled",void 0),e([n()],D.prototype,"editingEnabled",null),e([n()],D.prototype,"filterGeometry",null),e([n()],D.prototype,"filterBySelectionEnabled",null),e([n({readOnly:!0})],D.prototype,"grid",null),e([n()],D.prototype,"hiddenFields",null),e([n()],D.prototype,"highlightEnabled",null),e([n()],D.prototype,"highlightIds",null),e([n()],D.prototype,"icon",null),e([n()],D.prototype,"isQueryingOrSyncing",null),e([n()],D.prototype,"label",null),e([n()],D.prototype,"layer",null),e([n()],D.prototype,"layers",void 0),e([n()],D.prototype,"layerView",null),e([n(),C("esri/widgets/FeatureTable/t9n/FeatureTable")],D.prototype,"messages",null),e([n(),C("esri/t9n/common")],D.prototype,"messagesCommon",null),e([n(),C("esri/widgets/support/t9n/uriUtils")],D.prototype,"messagesURIUtils",null),e([n()],D.prototype,"menuConfig",void 0),e([n()],D.prototype,"multipleSelectionEnabled",null),e([n()],D.prototype,"multiSortEnabled",null),e([n()],D.prototype,"objectIds",null),e([n()],D.prototype,"pageSize",null),e([n()],D.prototype,"relatedRecordsEnabled",null),e([n()],D.prototype,"relatedTable",null),e([n()],D.prototype,"relatedTables",void 0),e([n()],D.prototype,"relationship",null),e([n()],D.prototype,"relationshipColumnConfigs",null),e([n()],D.prototype,"relationshipConfig",null),e([n()],D.prototype,"returnGeometryEnabled",null),e([n()],D.prototype,"returnMEnabled",null),e([n()],D.prototype,"returnZEnabled",null),e([n()],D.prototype,"rowHighlightIds",null),e([n()],D.prototype,"selectionSource",null),e([n()],D.prototype,"showRelatedTableCallback",null),e([n()],D.prototype,"size",null),e([n({readOnly:!0})],D.prototype,"state",null),e([n({constructOnly:!0})],D.prototype,"tableParent",void 0),e([n()],D.prototype,"tableTemplate",null),e([n()],D.prototype,"tableTemplateOverride",null),e([n()],D.prototype,"title",void 0),e([n()],D.prototype,"timeExtent",null),e([n()],D.prototype,"timeZone",null),e([n()],D.prototype,"view",null),e([n({type:p}),T(["cell-click","cell-pointerover","cell-pointerout","cell-keydown","show-related-table"])],D.prototype,"viewModel",void 0),e([n({type:m,nonNullable:!0})],D.prototype,"visibleElements",void 0),e([n({type:m})],D.prototype,"visibleElementsOverride",void 0),D=A=e([r("esri.widgets.FeatureTable")],D);const x=D;export{x as default};
