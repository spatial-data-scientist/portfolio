/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
import{createTask as o}from"../../core/asyncUtils.js";import{on as e}from"../../core/events.js";import{makeHandle as t}from"../../core/handleUtils.js";import{ignoreAbortErrors as i,isAborted as n,createResolver as s,onAbort as r}from"../../core/promiseUtils.js";import{whenOnce as c}from"../../core/reactiveUtils.js";import{waitAnimationFrame as a}from"../../core/scheduling.js";import{createScreenPoint as l}from"../../core/screenUtils.js";import p from"../../views/interactive/sketch/SketchTooltipVisibleElements.js";async function m(e,t,p={}){async function m(o){const i=h(e);if("coordinates"===t?(t="x",e.tooltipOptions.xyMode="coordinates"):"direction"!==t&&"distance"!==t||(e.tooltipOptions.xyMode="direction-distance"),await a(),n(p)||n(o))return;const m=i?.tooltip;if(!m||!i.activeTooltipInfo?.editableFields?.find((o=>o.name===t)))return;const{handle:d,promise:f}=v(m,p),u=s(),w=r(p.signal,u.resolve),y=r(o,u.resolve),O=m.position;try{if(e.tooltipOptions.forceEnabled=!0,p.position&&(m.position=l(p.position[0],p.position[1])),await m.enterInputMode(t),n(p)||n(o))return;p.onOpen?.(),await Promise.race([c((()=>i.destroyed||"feedback"===m.content?.mode),p),f,u.promise])}finally{w?.remove(),y?.remove(),d.remove();const o=m.contentContainer.contains(document.activeElement);e.tooltipOptions.enabled?await m.exitInputMode({focusOnView:o}):o&&e.view?.focus(),p.onClose?.(),m.position=O,e.tooltipOptions.forceEnabled=!1}}const f=d.get(e);f&&(f.abort(),await f.promise);const u=o(m);return d.set(e,u),u.promise.catch(i).finally((()=>{d.get(e)===u&&d.delete(e)}))}const d=new Map,f={area:!1,distance:!1,direction:!1,elevation:!1,orientation:!1,radius:!1,rotation:!1,scale:!1,size:!1,totalLength:!1,coordinates:!1,helpMessage:!1,header:!1};function u(o){o.tooltipOptions.visibleElements=new p(f)}function v(o,{hideOnBlur:i=!0}){const n=s();if(!i)return{promise:n.promise,handle:t()};const r=o.contentContainer,c=e(r,"focusout",(({relatedTarget:o})=>{o instanceof HTMLElement&&r.contains(o)||n.resolve()}));return{promise:n.promise,handle:c}}function h(o){const{activeComponent:e}=o;return e&&"tooltip"in e&&"activeTooltipInfo"in e&&"destroyed"in e?e:null}export{u as hideAllVisibleElements,m as showTooltipAndFocusField};
