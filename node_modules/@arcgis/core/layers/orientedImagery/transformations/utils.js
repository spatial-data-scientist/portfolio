/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
import"../../../geometry.js";import{rad2deg as t,deg2rad as a}from"../../../core/mathUtils.js";import{create as n}from"../../../core/libs/gl-matrix-2/factories/mat3f64.js";import{create as s}from"../../../core/libs/gl-matrix-2/factories/mat4f64.js";import{zeros as i}from"../../../core/libs/gl-matrix-2/factories/vec3f64.js";import{invertOrIdentity as h}from"../../../core/libs/gl-matrix-2/math/mat4.js";import{initializeProjection as o,projectWithZConversion as M}from"../../../geometry/projection.js";import{earth as r}from"../../../geometry/support/Ellipsoid.js";import{isWebMercator as c}from"../../../geometry/support/spatialReferenceUtils.js";import{geographicToWebMercator as e}from"../../../geometry/support/webMercatorUtils.js";import{defaultImageSphereSize as u}from"../../../widgets/PanoramicViewer/constants.js";import m from"../../../geometry/Point.js";function z(t,a,n){const[s,i,h,o]=a,[M,r,c,e]=n;return f(t,s,i,h,o,M,r,c,e)}function f(t,a,n,i,o,M,r,c,e){let u=!1;0===a.z&&0===n.z&&0===i.z&&0===o.z&&(a.z=n.z=i.z=o.z=1,t.z=1),a.z=a.z??1,n.z=n.z??1,i.z=i.z??1,o.z=o.z??1,0===M.z&&0===r.z&&0===c.z&&0===e.z&&(u=!0,M.z=r.z=c.z=e.z=1),M.z=M.z??1,r.z=r.z??1,c.z=c.z??1,e.z=e.z??1;const m=y(a,n,i,o),z=y(M,r,c,e),f=h(s(),m),x=s();x[0]=z[0]*f[0]+z[1]*f[4]+z[2]*f[8]+z[3]*f[12],x[1]=z[0]*f[1]+z[1]*f[5]+z[2]*f[9]+z[3]*f[13],x[2]=z[0]*f[2]+z[1]*f[6]+z[2]*f[10]+z[3]*f[14],x[3]=z[0]*f[3]+z[1]*f[7]+z[2]*f[11]+z[3]*f[15],x[4]=z[4]*f[0]+z[5]*f[4]+z[6]*f[8]+z[7]*f[12],x[5]=z[4]*f[1]+z[5]*f[5]+z[6]*f[9]+z[7]*f[13],x[6]=z[4]*f[2]+z[5]*f[6]+z[6]*f[10]+z[7]*f[14],x[7]=z[4]*f[3]+z[5]*f[7]+z[6]*f[11]+z[7]*f[15],x[8]=z[8]*f[0]+z[9]*f[4]+z[10]*f[8]+z[11]*f[12],x[9]=z[8]*f[1]+z[9]*f[5]+z[10]*f[9]+z[11]*f[13],x[10]=z[8]*f[2]+z[9]*f[6]+z[10]*f[10]+z[11]*f[14],x[11]=z[8]*f[3]+z[9]*f[7]+z[10]*f[11]+z[11]*f[15],x[12]=z[12]*f[0]+z[13]*f[4]+z[14]*f[8]+z[15]*f[12],x[13]=z[12]*f[1]+z[13]*f[5]+z[14]*f[9]+z[15]*f[13],x[14]=z[12]*f[2]+z[13]*f[6]+z[14]*f[10]+z[15]*f[14],x[15]=z[12]*f[3]+z[13]*f[7]+z[14]*f[11]+z[15]*f[15];const p=x[0]*t.x+x[1]*t.y+x[2]*t.z+x[3],l=x[4]*t.x+x[5]*t.y+x[6]*t.z+x[7],b=x[8]*t.x+x[9]*t.y+x[10]*t.z+x[11];let g=x[12]*t.x+x[13]*t.y+x[14]*t.z+x[15];return 0===g&&(g=1),{x:p/g,y:l/g,z:u?0:b/g}}function y(t,a,n,s){const i=b([s.x,s.y,s.z,1],h(new Array(16),[t.x,a.x,n.x,0,t.y,a.y,n.y,0,t.z,a.z,n.z,0,1,1,1,1])),o=i[0],M=i[1],r=i[2],c=new Array(16);return c[0]=o*t.x,c[1]=M*a.x,c[2]=r*n.x,c[3]=0,c[4]=o*t.y,c[5]=M*a.y,c[6]=r*n.y,c[7]=0,c[8]=o*t.z,c[9]=M*a.z,c[10]=r*n.z,c[11]=0,c[12]=o,c[13]=M,c[14]=r,c[15]=1,c}function x(t,a,n,s,h=i()){return h[0]=t[0]+a[0]*n,h[1]=t[1]+a[1]*n,h[2]=t[2]+a[2]*(n/s),h}function p(t,a,n){const s=i();return s[0]=t[0]*a,s[1]=t[1]*a,s[2]=t[2]*(a/n),s}function l(t,a){const[n,s,h]=t,o=i();return o[0]=n*a[0]+s*a[3]+h*a[6],o[1]=n*a[1]+s*a[4]+h*a[7],o[2]=n*a[2]+s*a[5]+h*a[8],o}function b(t,a){const[n,s,i,h]=t,o=new Array(4);return o[0]=n*a[0]+s*a[1]+i*a[2]+h*a[3],o[1]=n*a[4]+s*a[5]+i*a[6]+h*a[7],o[2]=n*a[8]+s*a[9]+i*a[10]+h*a[11],o[3]=n*a[12]+s*a[13]+i*a[14]+h*a[15],o}function g(t,a){const s=Math.PI/180,i=n();if("OPK"===t){const t=Number(a[0])*s,n=Number(a[1])*s,h=Number(a[2])*s;i[0]=Math.cos(n)*Math.cos(h),i[1]=Math.cos(t)*Math.sin(h)+Math.sin(t)*Math.sin(n)*Math.cos(h),i[2]=Math.sin(t)*Math.sin(h)-Math.cos(t)*Math.sin(n)*Math.cos(h),i[3]=-Math.cos(n)*Math.sin(h),i[4]=Math.cos(t)*Math.cos(h)-Math.sin(t)*Math.sin(n)*Math.sin(h),i[5]=Math.sin(t)*Math.cos(h)+Math.cos(t)*Math.sin(n)*Math.sin(h),i[6]=Math.sin(n),i[7]=-Math.sin(t)*Math.cos(n),i[8]=Math.cos(t)*Math.cos(n)}else{const t=Number(a[0])*s,n=Number(a[1])*s,h=Number(a[2])*s;i[0]=Math.cos(t)*Math.cos(h)-Math.sin(t)*Math.cos(n)*Math.sin(h),i[1]=Math.sin(t)*Math.cos(h)*-1-Math.cos(t)*Math.cos(n)*Math.sin(h),i[2]=Math.sin(h)*Math.sin(n)*-1,i[3]=Math.cos(t)*Math.sin(h)+Math.sin(t)*Math.cos(n)*Math.cos(h),i[4]=Math.sin(t)*Math.sin(h)*-1+Math.cos(t)*Math.cos(n)*Math.cos(h),i[5]=Math.cos(h)*Math.sin(n),i[6]=Math.sin(t)*Math.sin(n)*-1,i[7]=Math.cos(t)*Math.sin(n)*-1,i[8]=Math.cos(n)}return i}function d(t,a,n){const s=Math.sin(n*Math.PI/180),i=Math.cos(n*Math.PI/180),h=[[t,0],[t,a],[0,a]];h.forEach(((t,a)=>{h[a]=[i*t[0]-s*t[1],s*t[0]+i*t[1]]}));const o={xmin:Math.min(0,h[0][0],h[1][0],h[2][0]),xmax:Math.max(0,h[0][0],h[1][0],h[2][0]),ymin:Math.min(0,h[0][1],h[1][1],h[2][1]),ymax:Math.max(0,h[0][1],h[1][1],h[2][1])};return{hfov:Math.abs(o.xmax-o.xmin),vfov:Math.abs(o.ymax-o.ymin)}}function j(t,a,n,s,i,h){const o=n*(a.x-t.x)+s*(a.y-t.y)+i*(a.z-t.z);if(0===o)return null;const M=-(n*t.x+s*t.y+i*t.z+h)/o;return{x:t.x+M*(a.x-t.x),y:t.y+M*(a.y-t.y),z:t.z+M*(a.z-t.z)}}function q(t,a){const n=Math.PI/180,s=t.y*n,i=t.x*n,h=t.z||0,o=a[0]*n,M=a[1]*n,r=a[2]/Math.sqrt(1-a[3]*Math.sin(o)**2),c=i-M,e=a[2]/Math.sqrt(1-a[3]*Math.sin(s)**2),u=a[3]*(r*Math.sin(o)-e*Math.sin(s));return{x:(e+h)*Math.cos(s)*Math.sin(c),y:(e+h)*(Math.sin(s)*Math.cos(o)-Math.sin(o)*Math.cos(s)*Math.cos(c))+u*Math.cos(o),z:(e+h)*(Math.sin(s)*Math.sin(o)+Math.cos(o)*Math.cos(s)*Math.cos(c))-r+u*Math.sin(o)}}function w(t,a){const n=Math.PI/180,s=Number(t.x),i=Number(t.y),h=Number(t.z),o=a[0]*n,M=a[1]*n,r=a[2]/Math.sqrt(1-a[3]*Math.sin(o)**2),c=s/r,e=i/r,u=h/r,m=Math.cos(o)-Math.sin(o)*e+Math.cos(o)*u,z=Math.sin(o)+Math.cos(o)*e+Math.sin(o)*u,f=Math.sqrt(m**2+c**2),y=a[3]*r*Math.sin(o),x=o,p=Math.atan(z/f-(y-a[3]*(a[2]/Math.sqrt(1-a[3]*Math.sin(x)**2))*Math.sin(x))/(r*f)),l=Math.atan(z/f-(y-a[3]*(a[2]/Math.sqrt(1-a[3]*Math.sin(p)**2))*Math.sin(p))/(r*f)),b=Math.atan(z/f-(y-a[3]*(a[2]/Math.sqrt(1-a[3]*Math.sin(l)**2))*Math.sin(l))/(r*f)),g=Math.atan(z/f-(y-a[3]*(a[2]/Math.sqrt(1-a[3]*Math.sin(b)**2))*Math.sin(b))/(r*f)),d=Math.atan(s/(r*m))+M;return{x:d/n,y:g/n,z:s/(Math.cos(g)*Math.sin(d-M))-a[2]/Math.sqrt(1-a[3]*Math.sin(g)**2),spatialReference:{wkid:4326}}}function N(t){return t&&c(t?.spatialReference)?1/Math.cos(Math.PI/2-2*Math.atan(Math.exp(-1*t.y/r.radius))):1}function P(t,a,n){const s=360/a,i=180/n;return{heading:(t.x-a/2)*s,pitch:90-(t.y-n/2)*i}}function R(t,a,n,s=u/2){const{heading:i,pitch:h}=v(t,s);return I(i,h,a,n)}function I(t,a,n,s){return{x:n/2+t/(360/n),y:s-a/(180/s),heading:t,pitch:a}}function v(a,n){const s=t(Math.acos(-a.z/n));return{heading:t(Math.atan2(a.x,a.y)),pitch:s}}function A(t,n,s=u/2){return[s*(Math.sin(a(t))*Math.sin(a(n))),s*(Math.cos(a(t))*Math.sin(a(n))),s*Math.cos(a(180-n))]}async function E(a,n,s){await o(n.spatialReference,a.spatialReference,null,s);const i=await M(n,a.spatialReference,s);let h=t(Math.atan2(i.y-a.y,i.x-a.x));return h=h>=0&&h<=90?90-h:h>90&&h<=180?360-h+90:90+Math.abs(h),h}function U(t,a,n){const s=Math.cos(n),i=Math.sin(n),h=[1,0,0,1,0,0],o=h[0]*s+h[2]*i,M=h[1]*s+h[3]*i,r=-h[0]*i+h[2]*s,c=-h[1]*i+h[3]*s;h[0]=o,h[1]=M,h[2]=r,h[3]=c;return[t*h[0]+a*h[2]+h[4],t*h[1]+a*h[3]+h[5]]}function k(t){return 4===t?.type}function G(t,a){let n=t;if(k(a)){const{latitude:s,longitude:i,ellipsoidRadius:h,squaredEccentricity:o}=a;n=new m(w(t,[s,i,h,o]))}return n.spatialReference.isWGS84&&(n=e(n)),n}export{g as calculateRotationMatrix,d as computeHFOVAndVFOV,A as convertHeadingPitchToSphereVertex,I as convertOrientationToPixelLocation,P as convertPixelToHeadingPitch,v as convertSphereVertexToOrientation,R as convertSphereVertexToPixelLocation,q as geographicToLTP,G as getCameraLocationWhenCameraOrientation,E as getInitialAngle,j as getPlaneLineIntersectionPoint,N as getWebMercatorScalingFactor,k as hasCameraOrientationLTP,y as linearEquationSolve,w as ltpToGeographic,f as projectiveTransform,z as projectiveTransform2,U as rotatePixel,x as scaleAndAddWithFactor,p as scaleWithFactor,l as transformMat3,b as transformMat4};
