/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
import{_ as t}from"../../../../chunks/tslib.es6.js";import{prefersReducedMotion as e}from"../../../../core/a11yUtils.js";import"../../../../core/has.js";import{memoize as o}from"../../../../core/memoize.js";import{throwIfNotAbortError as s,throwIfAborted as i,after as n}from"../../../../core/promiseUtils.js";import{waitTick as r,waitAnimationFrame as a}from"../../../../core/scheduling.js";import{unitName as l}from"../../../../core/unitFormatUtils.js";import{defaultLengthUnit as c,defaultVerticalLengthUnit as p,defaultAreaUnit as d}from"../../../../core/unitUtils.js";import{property as u}from"../../../../core/accessorSupport/decorators/property.js";import"../../../../core/Logger.js";import"../../../../core/RandomLCG.js";import{subclass as m}from"../../../../core/accessorSupport/decorators/subclass.js";import{getDefaultUnitForView as h}from"../../../../support/getDefaultUnitForView.js";import{tooltipKeys as f}from"../../keybindings.js";import{table as g,contentHeader as _,contentHeaderSpacer as y,contentHeaderActions as b,contentInputMode as v,content as w,helpMessageText as j,helpMessageIcon as A,helpMessage as k,drawContentHeaderActions as U}from"../css.js";import{getFormatters as C}from"../fields/parsingAndFormattingUtils.js";import F from"../../../../widgets/Widget.js";import{loadCalciteComponents as I}from"../../../../widgets/support/componentsUtils.js";import{classes as M}from"../../../../widgets/support/widgetUtils.js";import{messageBundle as T}from"../../../../widgets/support/decorators/messageBundle.js";import{tsx as x,tsxFragment as E}from"../../../../widgets/support/jsxFactory.js";let D=class extends F{constructor(){super(...arguments),this._focusAbortController=new AbortController,this._transition=null,this._mode="feedback",this._getFormatters=o(C),this._onDiscard=()=>{this.info.clearInputValues(),this.exitInputMode()},this._onCommit=(t,e)=>{if("commit-and-exit"===e)return void this.exitInputMode();if("commit-on-blur"===e)return;const o=this._getFocusableElements(),s=o.length,i=o.indexOf(t);if(-1===i)return void this.exitInputMode();const n=((i+("commit-and-next"===e?1:-1))%s+s)%s;S(o.at(n))},this._handleTab=t=>{if(t.code!==f.next)return;const e=this._getFocusableElements(),o=e.at(0),s=e.at(-1);o&&s&&(t.shiftKey?document.activeElement===o&&(t.preventDefault(),S(s)):document.activeElement===s&&(t.preventDefault(),S(o)))}}get mode(){return this._mode}get _displayUnits(){const t=h(this.tooltip.view);return{length:t,verticalLength:t,area:t,angle:"degrees"}}get _inputUnitInfos(){const t=this._messagesUnits,e=e=>({unit:e,abbreviation:l(t,e,"abbr")}),o=h(this.tooltip.view),s=e(c(o)),i=e(p(o)),n=e(d(o)),r=e("degrees");return{length:s,lengthRelative:s,verticalLength:i,verticalLengthRelative:i,area:n,direction:r,orientation:r,rotation:r,longitudeLatitude:r}}get _formatters(){return this._getFormatters(this._messagesUnits,this._displayUnits)}get fieldContext(){return{formatters:this._formatters,inputUnitInfos:this._inputUnitInfos,messages:this._messagesTooltip,sketchOptions:this.info.sketchOptions,onCommit:this._onCommit,onDiscard:this._onDiscard}}render(){const{visibleElements:t}=this.info.sketchOptions.tooltips,e=this._renderedContent,o=this._renderedActions,s=this._renderedHelpMessage,i=e.length>0,n=i||!!s,r="input"===this.mode;return x("div",{class:M(w,r&&v),onkeydown:this._handleTab},r&&n&&t.header?x("div",{class:_,key:"header"},x("calcite-button",{appearance:"transparent","data-testid":"tooltip-back-button",iconFlipRtl:"both",iconStart:"chevron-left",key:"discard-button",kind:"neutral",onclick:this._onDiscard,scale:"s",tabIndex:-1}),o.length>0?x(E,null,x("div",{class:y,key:"spacer"}),x("div",{class:b,key:"actions"},o)):null):null,i?x("div",{class:g,key:"content"},...e):null,s)}_renderActions(){return null}loadDependencies(){return I({button:()=>import("@esri/calcite-components/dist/components/calcite-button.js"),icon:()=>import("@esri/calcite-components/dist/components/calcite-icon.js"),input:()=>import("@esri/calcite-components/dist/components/calcite-input.js")})}async enterInputMode(t){try{await this._transitionTo("input"),await this._focusField(t)}catch(e){s(e)}}async exitInputMode({focusOnView:t=!0}={}){try{const{container:e,info:o}=this;o.clearInputValues();const s=t?e?.closest(".esri-view")?.querySelector(".esri-view-surface"):null;await this._transitionTo("feedback"),s instanceof HTMLElement&&s.focus()}catch(e){s(e)}}get _renderedContent(){return H(this._renderContent())}get _renderedActions(){return H(this._renderActions())}get _renderedHelpMessage(){const{sketchOptions:t,visibleElements:e}=this.info;if(!e.helpMessage)return null;const o=t.tooltips.helpMessage??this._defaultHelpMessage;if(!o)return null;const s=t.tooltips.helpMessageIcon??"information";return x("div",{class:k,key:"help-message"},s?x("calcite-icon",{class:A,icon:s,scale:"s"}):null,x("div",{class:j},o))}get _defaultHelpMessage(){const{helpMessage:t,viewType:e}=this.info;if(null==t)return null;const o="3d"===e?"helpMessages3d":"helpMessages2d";return this._messagesTooltip?.sketch?.[o]?.[t]}async _focusField(t){this._focusAbortController?.abort(),this._focusAbortController=new AbortController;const{signal:e}=this._focusAbortController;await this._waitForInputs(),i(e);const o=this._getFocusableInputs(),s=t?o.find((e=>e.getAttribute("data-field-name")===t)):o.at(0);await S(s)}async _transitionTo(t){if(this._mode===t)return;const o=()=>{this._mode=t};if(!this.domNode?.firstChild||!document.startViewTransition||e())return void o();this.autoRenderingEnabled=!1,this._transition?.skipTransition();const s=this._transition=document.startViewTransition((()=>{if(!this.destroyed)return this.autoRenderingEnabled=!0,o(),this.renderNow(),r()}));try{await this._transition.finished}finally{s===this._transition&&(this._transition=null)}}async _waitForInputs(){const t=()=>Array.from(this.domNode?.querySelectorAll("calcite-input")??[]);for(;0===t().length;)await n(L);await a()}_getFocusableInputs(){return Array.from(this.domNode?.querySelectorAll("calcite-input:not([read-only]):not([disabled])")??[])}_getFocusableElements(){const t=this.domNode?.querySelector(`.${U}`);return[...Array.from(t?.querySelectorAll(`.${b} calcite-button:not([disabled])`)??[]),...this._getFocusableInputs()]}};async function S(t){await(t?.setFocus())}function H(t){return(Array.isArray(t)?t:[t]).flat(10).filter((t=>!!t))}t([T("esri/core/t9n/Units"),u()],D.prototype,"_messagesUnits",void 0),t([T("esri/views/interactive/tooltip/t9n/Tooltip"),u()],D.prototype,"_messagesTooltip",void 0),t([u()],D.prototype,"info",void 0),t([u()],D.prototype,"tooltip",void 0),t([u()],D.prototype,"_mode",void 0),t([u()],D.prototype,"mode",null),t([u()],D.prototype,"_displayUnits",null),t([u()],D.prototype,"_inputUnitInfos",null),t([u()],D.prototype,"_formatters",null),t([u()],D.prototype,"fieldContext",null),t([u()],D.prototype,"_renderedContent",null),t([u()],D.prototype,"_renderedActions",null),t([u()],D.prototype,"_renderedHelpMessage",null),t([u()],D.prototype,"_defaultHelpMessage",null),D=t([m("esri.views.interactive.tooltip.content.TooltipContent")],D);const L=20;export{D as TooltipContent};
