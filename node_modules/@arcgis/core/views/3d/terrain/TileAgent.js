/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
import"../../../core/has.js";import{TextureUpdate as e}from"./interfaces.js";import{progressiveLoadingModulo as t}from"./TerrainConst.js";import{getLayerWithExtentRange as s}from"./terrainUtils.js";import{fallsWithinLayer as i}from"./tileUtils.js";class l{get updating(){return!!this._tileRequested}init(e,t,s,i){this.tile=e,this._layerIdx=t,this._layerClass=s,this._suspended=i,this._tileLayerInfo=e.getLayerInfo(t,s),this._tileRequested=null;const l=this._findAncestorWithData();this._setUpsampleTile(l)}startLoading(){return this._requestNext()}dispose(){this._tileRequested&&(this._tileRequested.unrequestLayerData(this._layerIdx,this._layerClass,this),this._tileRequested=null),this.tile=null,this._tileLayerInfo=null}setSuspension(e){e!==this._suspended&&(this._suspended=e,e?this._tileRequested&&(this._tileRequested.unrequestLayerData(this._layerIdx,this._layerClass,this),this._tileRequested=null):this._tileLayerInfo.data||this.update())}update(){const e=this._findAncestorWithData();return this._setUpsampleTile(e),this._requestNext()}dataArrived(t,s){this._setUpsampleTile(t,s),this._tileRequested=null,t===this.tile?this.tile.updateRenderData(this._layerClass,e.FADING,s):this._requestNext()}dataMissing(){this._tileRequested=null,this._tileLayerInfo.data=null,this._requestNext()}_agentDone(){this.tile.agentDone(this._layerIdx,this._layerClass),this.dispose()}_requestNext(){if(this._suspended)return!0;const e=this._findNextDownload();if(this._tileRequested){if(e===this._tileRequested)return!0;this._tileRequested.unrequestLayerData(this._layerIdx,this._layerClass,this),this._tileRequested=null}return null!=e?e.requestLayerData(this._layerIdx,this._layerClass,this)&&(this._tileRequested=e):this._agentDone(),!!this._tileRequested}_findNextDownload(){const e=this._layerIdx,l=this._layerClass,a=this.tile.surface.layerViewByIndex(e,l),r=s(a),{minLevel:n,maxLevel:h}=a.dataLevelRange,d=this._desiredMinLevelDelta,u=this._progressiveLevelModulo+d,o=this._scaleRangeEnabled?i:()=>!0;let _=this.tile;const p=_.level;let y;const f=this._tileLayerInfo.upsampleInfo,c=null!=f?f.tile.level:-1,v=null!=f&&c-p>=d,q=r?.tilemapCache,I="vector-tile-3d"===a.type?a.schemaHelper:null;for(;_&&o(_,r,!1)&&_.level>=n;){const s=_.level,i=p-s,a=_.layerInfo[l][e];if(a.data&&i>=d){(!v||s>c)&&this._setUpsampleTile(_),a.dataInvalidated&&(y=_);break}const r=I?.getLevelRowColumn(_.lij)??_.lij;if("unavailable"!==q?.getAvailability(r[0],r[1],r[2])&&s<=h&&!a.data&&!a.dataMissing&&((!y||_.level===n||s%t==0||p-y.level<d)&&(y=_),i>=u))break;_=_.parent}if(null!=y&&p-y.level<d)if(f)y=null;else{const t=this._findAncestorWithData();if(null!=t){this._setUpsampleTile(t);y=t.layerInfo[l][e].dataInvalidated?t:null}}return y}_findAncestorWithData(){const e=this.tile.elevationLevel,t=this._desiredMinLevelDelta;let s;for(let i=this.tile;i;i=i.parent)if(i.hasLayerData(this._layerIdx,this._layerClass)){if(e-i.level>=t)return i;s=i}return s}_setUpsampleTile(t,s){this._tileLayerInfo.setUpsampleInfo(this.tile,t),this.tile.updateRenderData(this._layerClass,e.FADING,s)}get test(){}}class a extends l{constructor(){super(...arguments),this.type="none"}get _desiredMinLevelDelta(){throw r}get _progressiveLevelModulo(){throw r}dispose(){}}const r=new Error("Abstract method called on TileAgent"),n=new a;export{l as TileAgent,n as tileAgentDone};
