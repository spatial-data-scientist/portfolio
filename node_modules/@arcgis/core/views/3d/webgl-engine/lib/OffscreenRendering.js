/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
import"../../../../core/has.js";import{releaseMaybe as t}from"../../../../core/maybe.js";import{c as e}from"../../../../chunks/vec42.js";import{create as r}from"../../../../core/libs/gl-matrix-2/factories/vec4f64.js";import{ColorFormat as i,DepthFormat as h}from"../../webgl/formats.js";import{RendererTarget as s}from"./rendererUtils.js";import{TransparencyPassType as o}from"./TransparencyPassType.js";import{ColorAttachment as c,ClearBufferBit as a}from"../../../webgl/enums.js";import{ensureAttachmentMaxSize as l}from"../../../webgl/FramebufferObject.js";class f{constructor(t,e){this._fbos=t,this.compositingHelper=e,this._width=4,this._height=4,this._clearColor=r()}dispose(){this._color=t(this._color),this.releaseBuffers()}get framebuffer(){return this.color.attachDepth(this.depth),this.color.fbo}get colorTexture(){return this.color.getTexture()}get depthTexture(){return this.depth.attachment}initializeFrame(t,r,i){this._fbos.interactive=i===s.Default;const h=this._fbos.rctx;this._width=t.fullWidth,this._height=t.fullHeight,l(this,h.parameters.maxTextureSize);const o=this._color;return this._color=null,this.releaseBuffers(),e(this._clearColor,r),o}releaseBuffers(){this._color?.detachDepth(),this._depth=t(this._depth)}renderHUDVisibility(t,e,r){return t?.fbo?.width===this._width&&t?.fbo?.height===this._height||(t?.release(),t=this._fbos.acquire(this._width,this._height,"hud visibility",i.RGBA4)),t.attachDepth(r||this.depth),this._fbos.rctx.bindFramebuffer(t.fbo),this._fbos.rctx.clearFramebuffer(_),e(),t.detachDepth(),t}compositeToHUDVisibility(t,e){this._fbos.rctx.bindFramebuffer(t.hudVisibility?.fbo),this.compositingHelper.compositeHUD(t,e)}renderOITPass(t,e,r){let s,a;const{_width:l,_height:f}=this;switch(e){case o.ColorAlpha:s=this._fbos.acquire(l,f,r?"oit hud color alpha":"oit color alpha",i.RGBA16F),s.acquireColor(c.COLOR_ATTACHMENT1,i.R16F),a=[0,0,0,1];break;case o.FrontFace:s=this._fbos.acquire(l,f,r?"oit hud front":"oit front"),a=[0,0,0,0]}return r?s.acquireDepth(h.DEPTH16_BUFFER):s.attachDepth(this.depth),this._fbos.rctx.bindFramebuffer(s.fbo),this._fbos.rctx.clearFramebuffer(a,r,r),t(),s.detachDepth(),s}compositeToFramebuffer(t,e,r,i){this.bindFbo(),this.compositingHelper.composite(t,e,r,i)}compositeOIT(t,e,r,i){i?(this._fbos.rctx.bindFramebuffer(i.fbo),this._fbos.rctx.setClearColor(0,0,0,1e-13),this._fbos.rctx.clear(a.COLOR_BUFFER_BIT)):this.bindFbo(),this.compositingHelper.compositeOIT(t,e.getTexture(),e.getTexture(c.COLOR_ATTACHMENT1),r.getTexture())}renderDepthDetached(t){this._bindTarget(this.color),t(),this._bindTarget(this.color,this.depth)}renderToCachedFBO(e,r,s,o,c=i.RGBA,a=h.DEPTH16_BUFFER,l=this._width,f=this._height,_=null){return e?.fbo?.width===l&&e?.fbo?.height===f||(e=t(e)),e=e??this._fbos.acquire(l,f,r,c),_?.forEach((t=>e.acquireColor(t.attachment,t.format))),null!=a&&e.acquireDepth(a),this._fbos.rctx.bindFramebuffer(e.fbo),this._fbos.rctx.clearFramebuffer(o,!0,!0),s(),e}renderToTargets(t,e,r,i,h=!1,s=!1){this._bindTarget(e,r),this._fbos.rctx.clearFramebuffer(i,h,s),t(),e.detachDepth()}bindFbo(){const t=null==this._color;if(this._bindTarget(this.color,this.depth),t){const t=this._fbos.rctx;t.setClearStencil(0),t.setClearColor(this._clearColor[0],this._clearColor[1],this._clearColor[2],this._clearColor[3]),t.clear(a.COLOR_BUFFER_BIT|a.DEPTH_BUFFER_BIT|a.STENCIL_BUFFER_BIT)}}_bindTarget(t,e){t.attachDepth(e),this._fbos.rctx.bindFramebuffer(t.fbo)}get width(){return this._width}get height(){return this._height}get color(){return this._ensureColor()}_ensureColor(){return this._color||(this._color=this._fbos.acquire(this._width,this._height,"composite-color")),this._color}updateColor(t){const e=this._ensureColor();e.attachDepth(this.depth),this._color=t(e)}get depth(){return this._depth||(this._depth=this._fbos.acquireDepth(h.DEPTH_STENCIL_TEXTURE,this._width,this._height,"depth")),this._depth}}const _=[0,1,0,1];export{f as OffscreenRendering};
