/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
import{s as e,G as t,h as r}from"../../../../chunks/vec32.js";import{create as a}from"../../../../core/libs/gl-matrix-2/factories/vec3f64.js";import{newLayout as s}from"../../support/buffer/InterleavedLayout.js";import{ShaderOutput as i,isColor as n,isDepth as o,isColorHighlightOrDepth as h}from"../core/shaderLibrary/ShaderOutput.js";import{GLTextureMaterial as c}from"../lib/GLTextureMaterial.js";import{Material as u,RenderOccludedFlag as l}from"../lib/Material.js";import{RenderSlot as p}from"../lib/RenderSlot.js";import{VertexAttribute as m}from"../lib/VertexAttribute.js";import{VisualVariablePassParameters as d}from"./VisualVariablePassParameters.js";import{vertexAttributeLocations as T,LineMarkerTechnique as _}from"../shaders/LineMarkerTechnique.js";import{LineMarkerTechniqueConfiguration as f,LineMarkerSpace as E,LineMarkerAnchor as A}from"../shaders/LineMarkerTechniqueConfiguration.js";import{CapType as v}from"../shaders/RibbonLineTechniqueConfiguration.js";class O extends u{constructor(e){super(e,new g),this.produces=new Map([[p.OPAQUE_MATERIAL,e=>e===i.Highlight||n(e)&&this.parameters.renderOccluded===l.OccludeAndTransparentStencil],[p.OPAQUE_NO_SSAO_DEPTH,e=>o(e)],[p.OCCLUDER_MATERIAL,e=>h(e)&&this.parameters.renderOccluded===l.OccludeAndTransparentStencil],[p.TRANSPARENT_OCCLUDER_MATERIAL,e=>h(e)&&this.parameters.renderOccluded===l.OccludeAndTransparentStencil],[p.TRANSPARENT_MATERIAL,e=>n(e)&&this.parameters.writeDepth],[p.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL,e=>n(e)&&!this.parameters.writeDepth],[p.DRAPED_MATERIAL,e=>e===i.Color||e===i.Highlight]]),this._vertexAttributeLocations=T,this._configuration=new f,this._layout=this.createLayout()}getConfiguration(e,t){return this._configuration.output=e,this._configuration.space=t.slot===p.DRAPED_MATERIAL?E.Draped:this.parameters.worldSpace?E.World:E.Screen,this._configuration.hideOnShortSegments=this.parameters.hideOnShortSegments,this._configuration.hasCap=this.parameters.cap!==v.BUTT,this._configuration.anchor=this.parameters.anchor,this._configuration.hasTip=this.parameters.hasTip,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.hasOccludees=this.parameters.hasOccludees,this._configuration.writeDepth=this.parameters.writeDepth,this._configuration.vvSize=!!this.parameters.vvSize,this._configuration.vvColor=!!this.parameters.vvColor,this._configuration.vvOpacity=!!this.parameters.vvOpacity,this._configuration.occluder=this.parameters.renderOccluded===l.OccludeAndTransparentStencil,this._configuration.transparencyPassType=t.transparencyPassType,this._configuration.multipassEnabled=t.multipassEnabled,this._configuration.cullAboveGround=t.multipassTerrain.cullAboveGround,this._configuration}intersect(){}createLayout(){const e=s().vec3f(m.POSITION).vec3f(m.PREVPOSITION).vec2f(m.UV0);return this.parameters.worldSpace&&e.vec3f(m.NORMAL),this.parameters.vvSize?e.f32(m.SIZEFEATUREATTRIBUTE):e.f32(m.SIZE),this.parameters.vvColor?e.f32(m.COLORFEATUREATTRIBUTE):e.vec4f(m.COLOR),this.parameters.vvOpacity&&e.f32(m.OPACITYFEATUREATTRIBUTE),e}createBufferWriter(){return new R(this._layout,this.parameters)}createGLMaterial(e){return new S(e)}}class S extends c{constructor(){super(...arguments),this._markerPrimitive=null}dispose(){super.dispose(),this._markerTextures.release(this._markerPrimitive),this._markerPrimitive=null}_updateParameters(e){const t=this._material.parameters.markerPrimitive;return t!==this._markerPrimitive&&(this._material.setParameters({markerTexture:this._markerTextures.swap(t,this._markerPrimitive)}),this._markerPrimitive=t),this._material.setParameters(this.textureBindParameters),this.ensureTechnique(_,e)}_updateOccludeeState(e){e.hasOccludees!==this._material.parameters.hasOccludees&&this._material.setParameters({hasOccludees:e.hasOccludees})}beginSlot(e){return this._output===i.Color&&this._updateOccludeeState(e),this._updateParameters(e)}}class g extends d{constructor(){super(...arguments),this.width=0,this.color=[1,1,1,1],this.markerPrimitive="arrow",this.placement="end",this.cap=v.BUTT,this.anchor=A.Center,this.hasTip=!1,this.worldSpace=!1,this.hideOnShortSegments=!1,this.writeDepth=!0,this.hasSlicePlane=!1,this.vvFastUpdate=!1,this.hasOccludees=!1,this.markerTexture=null}}class R{constructor(e,t){this.vertexBufferLayout=e,this._parameters=t}elementCount(){return"begin-end"===this._parameters.placement?12:6}write(a,s,i,n,o){const h=i.attributes.get(m.POSITION).data,c=h.length/3;let u=[1,0,0];const l=i.attributes.get(m.NORMAL);this._parameters.worldSpace&&null!=l&&(u=l.data);let p=1,d=0;this._parameters.vvSize?d=i.attributes.get(m.SIZEFEATUREATTRIBUTE).data[0]:i.attributes.has(m.SIZE)&&(p=i.attributes.get(m.SIZE).data[0]);let T=[1,1,1,1],_=0;this._parameters.vvColor?_=i.attributes.get(m.COLORFEATUREATTRIBUTE).data[0]:i.attributes.has(m.COLOR)&&(T=i.attributes.get(m.COLOR).data);let f=0;this._parameters.vvOpacity&&(f=i.attributes.get(m.OPACITYFEATUREATTRIBUTE).data[0]);const E=new Float32Array(n.buffer);let A=o*(this.vertexBufferLayout.stride/4);const v=(e,t,r,a)=>{if(E[A++]=e[0],E[A++]=e[1],E[A++]=e[2],E[A++]=t[0],E[A++]=t[1],E[A++]=t[2],E[A++]=r[0],E[A++]=r[1],this._parameters.worldSpace&&(E[A++]=u[0],E[A++]=u[1],E[A++]=u[2]),this._parameters.vvSize?E[A++]=d:E[A++]=p,this._parameters.vvColor)E[A++]=_;else{const e=Math.min(4*a,T.length-4);E[A++]=T[e],E[A++]=T[e+1],E[A++]=T[e+2],E[A++]=T[e+3]}this._parameters.vvOpacity&&(E[A++]=f)};let O;!function(e){e[e.ASCENDING=1]="ASCENDING",e[e.DESCENDING=-1]="DESCENDING"}(O||(O={}));const S=(s,i)=>{const n=e(P,h[3*s],h[3*s+1],h[3*s+2]),o=I;let u=s+i;do{e(o,h[3*u],h[3*u+1],h[3*u+2]),u+=i}while(t(n,o)&&u>=0&&u<c);a&&(r(n,n,a),r(o,o,a)),v(n,o,[-1,-1],s),v(n,o,[1,-1],s),v(n,o,[1,1],s),v(n,o,[-1,-1],s),v(n,o,[1,1],s),v(n,o,[-1,1],s)},g=this._parameters.placement;"begin"!==g&&"begin-end"!==g||S(0,O.ASCENDING),"end"!==g&&"begin-end"!==g||S(c-1,O.DESCENDING)}}const P=a(),I=a();export{O as LineMarkerMaterial,g as Parameters};
