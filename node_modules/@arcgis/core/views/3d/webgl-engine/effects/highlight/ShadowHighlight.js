/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
import{_ as e}from"../../../../../chunks/tslib.es6.js";import{unitRGBAFromColor as t}from"../../../../../core/colorUtils.js";import{smoothstep as s,clamp as i}from"../../../../../core/mathUtils.js";import{watch as r,syncAndInitial as a}from"../../../../../core/reactiveUtils.js";import{property as o}from"../../../../../core/accessorSupport/decorators/property.js";import"../../../../../core/has.js";import"../../../../../core/Logger.js";import"../../../../../core/RandomLCG.js";import{subclass as h}from"../../../../../core/accessorSupport/decorators/subclass.js";import{n as c,s as p,m as n}from"../../../../../chunks/vec32.js";import{create as d}from"../../../../../core/libs/gl-matrix-2/factories/vec3f64.js";import{ViewingMode as m}from"../../../../ViewingMode.js";import l from"../../../webgl/RenderNode.js";import{defaultShadowOpacity as u,defaultShadowDifference as g,defaultShadowColor as f}from"./HighlightDefaults.js";import{ShadowHighlightPassParameters as _,ShadowHighlightTechnique as w}from"./ShadowHighlightTechnique.js";import{RenderRequestType as y}from"../../lib/basicInterfaces.js";const O=.001953125,v=4e4,P=5e4;let b=class extends l{constructor(e){super(e),this.produces="composite-color",this.consumes={required:["composite-color","highlights"]},this._passParameters=new _,this._maxOpacity=1,this._shadowDifference=.2,this._technique=e.techniques.acquire(w)}initialize(){this.addHandles([r((()=>this.view.highlightOptions.shadowOpacity),(e=>{this._passParameters.shadowOpacity=e??u,this._updateOccludedShadowOpacity(),this._updateMaxOpacity()}),a),r((()=>this.view.highlightOptions.shadowDifference),(e=>{this._shadowDifference=e??g,this._updateOccludedShadowOpacity(),this._updateMaxOpacity()}),a),r((()=>this.view.highlightOptions.shadowColor),(e=>{this._passParameters.shadowColor=t(e??f),this._updateMaxOpacity()}),a)])}destroy(){this._technique.release()}_updateOccludedShadowOpacity(){this._passParameters.occludedShadowOpacity=this._passParameters.shadowOpacity*(1-this._shadowDifference)}_updateMaxOpacity(){const e=Math.max(this._passParameters.shadowOpacity,this._passParameters.occludedShadowOpacity);this._maxOpacity=e*this._passParameters.shadowColor[3]}render(e){const t=e.find((({name:e})=>"composite-color"===e)),s=this.bindParameters;if(!s.shadowHighlightsVisible||!s.depth||!this._ensureIfVisible(s.camera,s.lighting.mainLight.direction))return t;if(!this._technique.compiled)return this.requestRender(y.UPDATE),t;this._passParameters.highlight=e.find((({name:e})=>"highlights"===e))?.getTexture(),this._passParameters.origin=s.camera.center;const i=this.renderingContext;return i.bindFramebuffer(t.fbo),i.bindTechnique(this._technique,s,this._passParameters),i.screen.draw(),t}_ensureIfVisible(e,t){this._passParameters.opacityElevation=1-s(v,P,e.relativeElevation);const r=this.viewingMode===m.Global?c(j,e.center):p(j,0,0,1),a=n(r,t);return this._passParameters.dayNightTerminator=s(0,1,i(30*a,0,1)),this._maxOpacity*this._passParameters.opacityElevation*this._passParameters.dayNightTerminator>=O}};e([o()],b.prototype,"produces",void 0),e([o()],b.prototype,"consumes",void 0),e([o({constructOnly:!0})],b.prototype,"viewingMode",void 0),e([o({constructOnly:!0})],b.prototype,"techniques",void 0),b=e([h("esri.views.3d.webgl-engine.effects.highlight.ShadowHighlight")],b);const j=d();export{b as ShadowHighlight};
