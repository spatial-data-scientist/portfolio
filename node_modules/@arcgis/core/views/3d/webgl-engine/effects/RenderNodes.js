/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
import e from"../../../../core/Logger.js";import o from"../../../../core/PooledArray.js";import{isManagedFBO as s}from"../../webgl/utils.js";import{defaultWebGLFBO as r}from"../core/FBOCache.js";import{hasFeatureFlagWebGLDebug as t}from"../../../webgl/checkWebGLError.js";class n{constructor(e){this._context=e,this._nodes=new o}destroy(){this._nodes.forEach((e=>e.destroy())),this._nodes.clear()}add(e){this._nodes.push(e),t&&console.log(`Registered render nodes: ${this._nodes.map((({declaredClass:e})=>e)).join(", ")}`)}remove(e){this._nodes.remove(e),t&&console.log(`Registered render nodes: ${this._nodes.map((({declaredClass:e})=>e)).join(", ")}`)}produces(e){return this._nodes.some((({produces:o})=>o===e))}require(e,...o){const s=this._nodes;return o.reduce(((o,r)=>o+s.reduce(((o,{consumes:s,produces:t})=>o+(s.required.includes(e)&&t===r?1:0)),0)),0)}optional(e,...o){const s=this._nodes;return o.reduce(((o,r)=>o+s.reduce(((o,{consumes:s,produces:t})=>o+(s.optional?.includes(e)&&t===r?1:0)),0)),0)}updateAnimation(){return this._nodes.reduce(((e,o)=>o.updateAnimation()||e),!1)}render(o,t,n=(()=>{})){const c=s(o)?o.name:o,d=this._nodes.filter((({produces:e})=>e===c));return 0===d.length||(d.forEach((r=>{const d=s(o)?[o]:[];for(const e of r.consumes.required){if(e===c)continue;const o=t.get(e);if(!o)return void(n&&n(d));d.push(o)}if(r.consumes.optional)for(const e of r.consumes.optional){if(e===c)continue;const o=t.get(e);o&&d.push(o)}try{const e=r.doRender(d,this._context);e&&e!==o&&(s(o)?(o.release(),o=e,t.set(c,o)):o=e)}catch(i){e.getLogger(r).errorOnce(i)}n&&n(d)})),this._context.rctx.enforceState()),s(o)?o:r}}export{n as RenderNodes};
