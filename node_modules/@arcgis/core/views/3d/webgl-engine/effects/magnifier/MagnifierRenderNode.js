/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
import{_ as e}from"../../../../../chunks/tslib.es6.js";import{createTask as s}from"../../../../../core/asyncUtils.js";import{clamp as i}from"../../../../../core/mathUtils.js";import{disposeMaybe as r}from"../../../../../core/maybe.js";import{watch as t,syncAndInitial as a}from"../../../../../core/reactiveUtils.js";import{createScreenPointArray as o,createRenderScreenPointArray as m,screenPointObjectToArray as n}from"../../../../../core/screenUtils.js";import{isSVG as l}from"../../../../../core/urlUtils.js";import{property as h}from"../../../../../core/accessorSupport/decorators/property.js";import"../../../../../core/has.js";import"../../../../../core/Logger.js";import"../../../../../core/RandomLCG.js";import{subclass as u}from"../../../../../core/accessorSupport/decorators/subclass.js";import{requestImage as p}from"../../../../../support/requestImageUtils.js";import c from"../../../webgl/RenderNode.js";import{MagnifierTechnique as _}from"./MagnifierTechnique.js";import{RenderRequestType as d}from"../../lib/basicInterfaces.js";import{Default3D as g}from"../../lib/DefaultVertexAttributeLocations.js";import{Pos2 as f}from"../../lib/DefaultVertexBufferLayouts.js";import{createQuadVAO as v}from"../../lib/glUtil3D.js";import{M as P}from"../../../../../chunks/Magnifier.glsl.js";import{loadMagnifierResources as T}from"../../../../magnifier/resources.js";import{PrimitiveType as y,PixelFormat as k,TextureWrapMode as b}from"../../../../webgl/enums.js";import{Texture as j}from"../../../../webgl/Texture.js";import{TextureDescriptor as x}from"../../../../webgl/TextureDescriptor.js";let S=class extends c{constructor(e){super(e),this.produces="magnifier-color",this.consumes={required:["magnifier-color"]},this._imageSources=null,this._imageLoadTask=null,this._passParameters=new P,this._vao=null,this._technique=null,this._magnifier=null,this._tmpScreenPoint=o(),this._tmpRenderPoint=m()}initialize(){this.addHandles([t((()=>this.view.magnifier),(e=>this._update(e)),a)])}_update(e){if(e===this._magnifier)return;this.removeAllHandles(),this._magnifier=e;const s=()=>{const e=this._validMagnifier;e?(this._loadResources(e),this.produces="magnifier-color"):this.produces="disabled",this.requestRender()};this._magnifier&&this.addHandles(t((()=>this._magnifier?.version),s)),s()}get _validMagnifier(){return this._magnifier?.visible&&this._magnifier?.position&&this._magnifier?.size>0?this._magnifier:null}get _factor(){return this._magnifier?.factor||1}destroy(){this._magnifier=null,null!=this._imageLoadTask&&(this._imageLoadTask.task.abort(),this._imageLoadTask=null),this._disposeTextures(),this._vao=r(this._vao)}_disposeTextures(){this._passParameters.mask=r(this._passParameters.mask),this._passParameters.overlay=r(this._passParameters.overlay),this._passParameters.input=r(this._passParameters.input)}render(e){const s=this._validMagnifier,r=e.find((({name:e})=>"magnifier-color"===e));if(null==s)return r;if(null==this._imageSources)return this.requestRender(d.UPDATE),r;const t=this.renderingContext,a=this.camera.pixelRatio,o=Math.ceil(a*s.size);if(this._vao??=v(t,f,g,0,1),this._technique??=this.techniques.acquire(_),this._ensureTextureResources(t,o),!this._technique?.compiled||!this._passParameters.input)return this.requestRender(d.UPDATE),r;const m=Math.ceil(1/this._factor*o),l=this._passParameters.input;l.resize(m,m),n(s.position,this._tmpScreenPoint);const h=this.camera.screenToRender(this._tmpScreenPoint,this._tmpRenderPoint),u=this.camera.fullWidth,p=this.camera.fullHeight,c=.5*m,P=.5*m;h[0]=i(h[0],c,u-c-1),h[1]=i(h[1],P,p-P-1);const T=Math.floor(h[0]-c),k=Math.floor(h[1]-P);t.bindFramebuffer(r.fbo);return this._technique.program.bindTexture("textureInput",l),t.gl.copyTexImage2D(l.descriptor.target,0,l.descriptor.pixelFormat,T,k,m,m,0),this._passParameters.magnifier=s,t.bindTechnique(this._technique,this.bindParameters,this._passParameters),t.bindVAO(this._vao),t.drawArrays(y.TRIANGLE_STRIP,0,4),r}_loadResources(e){const{maskUrl:i,overlayUrl:r}=e;this._imageLoadTask?.maskUrl===i&&this._imageLoadTask?.overlayUrl===r||(this._imageLoadTask?.task.abort(),this._imageLoadTask=this._imageSources=null),this._imageSources||this._imageLoadTask||(this._imageLoadTask={maskUrl:i,overlayUrl:r,task:s((async e=>{const s=null==i||null==r?T(e):null,t=null!=i?p(i,{signal:e}):s.then((e=>e.mask)),a=null!=r?p(r,{signal:e}):s.then((e=>e.overlay));this._imageSources={mask:await t,overlay:await a}}))})}_ensureTextureResources(e,s){if(null==this._imageSources||this._passParameters.size===s&&this._passParameters.input&&this._passParameters.mask&&this._passParameters.overlay)return;this._disposeTextures(),this._imageSources.overlay.width=this._imageSources.mask.width=s,this._imageSources.overlay.height=this._imageSources.mask.height=s;const i=new x;i.internalFormat=k.RGBA,i.wrapMode=b.CLAMP_TO_EDGE,i.flipped=!0,i.preMultiplyAlpha=!l(this._imageSources.overlay.src)||!e.driverTest.svgPremultipliesAlpha.result,this._passParameters.overlay=new j(e,i,this._imageSources.overlay),i.pixelFormat=i.internalFormat=k.ALPHA,i.preMultiplyAlpha=!1,this._passParameters.mask=new j(e,i,this._imageSources.mask),i.pixelFormat=i.internalFormat=k.RGBA,i.flipped=!1,this._passParameters.input=new j(e,i)}};e([h()],S.prototype,"produces",void 0),e([h()],S.prototype,"consumes",void 0),e([h()],S.prototype,"_imageSources",void 0),e([h()],S.prototype,"_imageLoadTask",void 0),e([h({constructOnly:!0})],S.prototype,"techniques",void 0),S=e([u("esri.views.3d.webgl-engine.effects.magnifier.MagnifierRenderNode")],S);export{S as MagnifierRenderNode};
