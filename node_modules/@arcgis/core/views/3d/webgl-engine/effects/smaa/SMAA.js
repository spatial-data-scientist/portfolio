/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
import{_ as e}from"../../../../../chunks/tslib.es6.js";import{disposeMaybe as r}from"../../../../../core/maybe.js";import{throwIfAborted as t}from"../../../../../core/promiseUtils.js";import{watch as s,syncAndInitial as i}from"../../../../../core/reactiveUtils.js";import{property as o}from"../../../../../core/accessorSupport/decorators/property.js";import"../../../../../core/has.js";import"../../../../../core/Logger.js";import"../../../../../core/RandomLCG.js";import{subclass as a}from"../../../../../core/accessorSupport/decorators/subclass.js";import{requestImage as n}from"../../../../../support/requestImageUtils.js";import{ColorFormat as u}from"../../../webgl/formats.js";import c from"../../../webgl/RenderNode.js";import{SMAABlendWeightsTechnique as l}from"./SMAABlendWeightsTechnique.js";import{SMAABlurTechnique as h}from"./SMAABlurTechnique.js";import{SMAAEdgeDetectTechnique as m}from"./SMAAEdgeDetectTechnique.js";import{SMAAPassParameters as d}from"./SMAAPassParameters.js";import{RenderRequestType as p}from"../../lib/basicInterfaces.js";import{PixelFormat as T,TextureSamplingMode as b,ClearBufferBit as _,TextureWrapMode as f}from"../../../../webgl/enums.js";import{Texture as x}from"../../../../webgl/Texture.js";import{TextureDescriptor as q}from"../../../../webgl/TextureDescriptor.js";let g=class extends c{constructor(e){super(e),this.produces="disabled",this.consumes={required:["aa-color","composite-color"]},this._areaTexture=null,this._searchTexture=null,this._smaaParameters=new d,this._edgeTechnique=e.techniques.acquire(m),this._blendTechnique=e.techniques.acquire(l),this._blurTechnique=e.techniques.acquire(h)}initialize(){this.addHandles([s((()=>this.isEnabled()),(e=>e?this.enable():this.disable()),i)])}async enable(){if(this.produces="aa-color",this._abortController||this._areaTexture&&this._searchTexture)return;this._abortController=new AbortController;const e=this._abortController.signal;try{const r=await import("./SMAAData.js");await this._loadTextures(r,e),this.requestRender(p.UPDATE)}catch{}this._abortController=null}async _loadTextures(e,r){t(r);const[s,i]=await Promise.allSettled([n(e.areaTexture,{signal:r}),n(e.searchTexure,{signal:r})]);if(t(r),"fulfilled"!==s.status||"fulfilled"!==i.status)return;const o=this.renderingContext;this._areaTexture=w(o,b.LINEAR,T.RGB,s.value),this._searchTexture=w(o,b.NEAREST,T.LUMINANCE,i.value)}disable(){this.produces="disabled"}destroy(){this._searchTexture=r(this._searchTexture),this._areaTexture=r(this._areaTexture),this._blurTechnique.release(),this._blendTechnique.release(),this._edgeTechnique.release()}render(e){const r=e.find((({name:e})=>"aa-color"===e));if(!(this._edgeTechnique.compiled&&this._blendTechnique.compiled&&this._blurTechnique.compiled&&this._areaTexture&&this._searchTexture))return this.requestRender(p.UPDATE),r;const t=e.find((({name:e})=>"composite-color"===e)),s=t.fbo.width,i=t.fbo.height,o=this.renderingContext;o.setViewport(0,0,s,i);const a=this.fboCache.acquire(s,i,"smaa edges",u.RG);o.unbindTexture(a.fbo?.colorTexture),o.bindFramebuffer(a.fbo),o.setClearColor(0,0,0,1),o.clear(_.COLOR_BUFFER_BIT),this._smaaParameters.color=t.getTexture(),o.bindTechnique(this._edgeTechnique,null,this._smaaParameters),o.screen.draw();const n=this.fboCache.acquire(s,i,"smaa blend");return o.unbindTexture(n.fbo?.colorTexture),o.bindFramebuffer(n.fbo),o.setClearColor(0,0,1,1),o.clear(_.COLOR_BUFFER_BIT),this._smaaParameters.inputTexture=a.getTexture(),this._smaaParameters.areaTexture=this._areaTexture,this._smaaParameters.searchTexture=this._searchTexture,o.bindTechnique(this._blendTechnique,null,this._smaaParameters),o.screen.draw(),a.release(),o.bindFramebuffer(r.fbo),o.setClearColor(0,1,0,1),o.clear(_.COLOR_BUFFER_BIT),this._smaaParameters.inputTexture=n.getTexture(),o.bindTechnique(this._blurTechnique,null,this._smaaParameters),o.screen.draw(),n.release(),r}};function w(e,r,t,s){const i=new q;return i.pixelFormat=t,i.wrapMode=f.CLAMP_TO_EDGE,i.width=s.width,i.height=s.height,i.samplingMode=r,new x(e,i,s)}e([o()],g.prototype,"produces",void 0),e([o()],g.prototype,"consumes",void 0),e([o({constructOnly:!0})],g.prototype,"isEnabled",void 0),e([o({constructOnly:!0})],g.prototype,"techniques",void 0),e([o()],g.prototype,"_abortController",void 0),g=e([a("esri.views.3d.webgl-engine.effects.smaa.SMAA")],g);export{g as SMAA};
