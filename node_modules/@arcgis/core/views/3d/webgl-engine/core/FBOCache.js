/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
import{ColorFormat as e,DepthFormat as t}from"../../webgl/formats.js";import{ManagedColorAttachment as r}from"../../webgl/ManagedColorAttachment.js";import{ManagedDepthAttachment as a}from"../../webgl/ManagedDepthAttachment.js";import c from"../../webgl/ManagedFBO.js";import{AttachmentType as h}from"../../webgl/ManagedFBObject.js";import{FBOPool as i}from"./FBOPool.js";import{PixelFormat as o,SizedPixelFormat as s,TextureWrapMode as n,PixelType as _,TextureSamplingMode as d,RenderbufferFormat as l,ColorAttachment as m}from"../../../webgl/enums.js";import{FramebufferObject as p}from"../../../webgl/FramebufferObject.js";import{Renderbuffer as u}from"../../../webgl/Renderbuffer.js";import{RenderbufferDescriptor as w}from"../../../webgl/RenderbufferDescriptor.js";import{Texture as C}from"../../../webgl/Texture.js";import{TextureDescriptor as E}from"../../../webgl/TextureDescriptor.js";class f{constructor(e){this.rctx=e,this._acquired=new Set,this._cache=new i(e.newCache,"FBOCache"),this._depthCache=new i(e.newCache,"DepthAttachmentCache"),this._colorCache=new i(e.newCache,"ColorAttachmentCache")}destroy(){this._cache.destroy(),this._depthCache.destroy(),this._colorCache.destroy()}clean(){this._cache.clean(),this._colorCache.clean(),this._depthCache.clean()}frameStart(){this._cache.frame(),this._colorCache.frame(),this._depthCache.frame(),this.debugCallback&&this.debugCallback()}frameEnd(){const e=this.debugCallback;e&&this._acquired.forEach((t=>t.type===h.FBO&&e(t.name,t.fbo)))}get usedMemory(){return Array.from(this._acquired.values()).reduce(((e,t)=>e+("getTexture"in t?t.getTexture()?.usedMemory??0:t.usedMemory)),this._cache.usedMemory+this._colorCache.usedMemory+this._depthCache.usedMemory)}set interactive(e){this._cache.interactive=this._colorCache.interactive=this._depthCache.interactive=e}acquire(r,a,h,i=e.RGBA){const o=b(i,r,a);let s=this._cache.pop(o);if(s){s.retain(),s.setName(h);const e=this.rctx.getBoundFramebufferObject();this.rctx.bindFramebuffer(s.fbo),this.rctx.setDrawBuffers([m.COLOR_ATTACHMENT0]),this.rctx.bindFramebuffer(e)}else s=new c(o,h,new p(this.rctx,{...O[i],width:r,height:a}),(e=>{e??=t.DEPTH_STENCIL_TEXTURE;const r=this._acquireDepth(e,s.fbo.width,s.fbo.height,`${s.name} depth`);return s.attachDepth(r),r.release(),s}),((t,c)=>{c??=e.RGBA;const h=this._acquireColor(c,r,a,`${s.name} color ${t}`);return s.attachColor(h,t),h.release(),s}),(()=>{this.debugCallback&&this.debugCallback(s.name,s.fbo),this._acquired.delete(s),s.detachAll(),this._cache.put(s)}));return this._trackHandle(s)}acquireDepth(e,t,r,a){return this._acquireDepth(e,t,r,a)}_acquireDepth(e,r,c,h){const i=b(e,r,c),o=this._depthCache.pop(i);if(o)return o.retain(),o.name=h,this._trackHandle(o);const s=e===t.DEPTH_STENCIL_TEXTURE?new a(i,new C(this.rctx,{...N[e],width:r,height:c}),(()=>{this._acquired.delete(s),this._depthCache.put(s)})):new a(i,new u(this.rctx,{...N[e],width:r,height:c}),(()=>{this._acquired.delete(s),this._depthCache.put(s)}));return s.name=h,this._trackHandle(s)}_acquireColor(e,t,a,c){const h=b(e,t,a),i=this._colorCache.pop(h);if(i)return i.retain(),i.name=c,this._trackHandle(i);const o=new r(h,new C(this.rctx,{...O[e],width:t,height:a}),(()=>{this._acquired.delete(o),this._colorCache.put(o)}));return o.name=c,this._trackHandle(o)}_trackHandle(e){return this._acquired.add(e),e}}const T=new c("default","default",null,(()=>T),(()=>T),(()=>{}));function b(e,t,r){return`${e}x${t}x${r}`}const A=new E;A.pixelFormat=o.RED,A.internalFormat=s.R8,A.wrapMode=n.CLAMP_TO_EDGE;const g=new E;g.pixelFormat=o.RG,g.internalFormat=s.RG8,g.wrapMode=n.CLAMP_TO_EDGE;const M=new E;M.internalFormat=s.RGBA4,M.dataType=_.UNSIGNED_SHORT_4_4_4_4,M.wrapMode=n.CLAMP_TO_EDGE;const R=new E;R.wrapMode=n.CLAMP_TO_EDGE;const F=new E;F.wrapMode=n.CLAMP_TO_EDGE,F.samplingMode=d.LINEAR_MIPMAP_LINEAR,F.hasMipmap=!0,F.maxAnisotropy=8;const D=new E;D.pixelFormat=o.RED,D.dataType=_.HALF_FLOAT,D.internalFormat=s.R16F,D.samplingMode=d.NEAREST;const x=new E;x.dataType=_.HALF_FLOAT,x.internalFormat=s.RGBA16F,x.samplingMode=d.NEAREST;const O={[e.RED]:A,[e.RG]:g,[e.RGBA4]:M,[e.RGBA]:R,[e.RGBA_MIPMAP]:F,[e.R16F]:D,[e.RGBA16F]:x},G=new E;G.pixelFormat=o.DEPTH_STENCIL,G.dataType=_.UNSIGNED_INT_24_8,G.samplingMode=d.NEAREST,G.wrapMode=n.CLAMP_TO_EDGE;const N={[t.DEPTH_STENCIL_TEXTURE]:G,[t.DEPTH16_BUFFER]:new w(l.DEPTH_COMPONENT16,4)};export{f as FBOCache,T as defaultWebGLFBO};
