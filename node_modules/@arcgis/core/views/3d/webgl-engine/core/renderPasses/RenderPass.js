/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
import e from"../../../../../core/PooledArray.js";import{TransparencyPassType as t}from"../../lib/TransparencyPassType.js";import{DataType as r}from"../../../../webgl/enums.js";var a;!function(e){e[e.FrontToBack=0]="FrontToBack",e[e.BackToFront=1]="BackToFront"}(a||(a={}));class i{constructor(t,r,i=a.FrontToBack){this._rctx=t,this._techniques=r,this._sorting=i,this._draws=new e({initialSize:32,allocator:e=>e||{material:null,geometry:null,geometryRanges:null,bindDrawParams:null,depthSquaredHint:0,indexType:0}}),this._previouslyBoundDraw=new Map}submitDraw(e,t,r,a){const i=this._draws.pushNew();i.geometry=t,i.geometryRanges=r,i.material=e,i.depthSquaredHint=a,i.indexType=(t.indexed?t.vao.indexBuffer.indexType:null)??0}prepare(e,t){return this._draws.map((r=>r.material.prepareTechnique(this._techniques,e,t,r.geometry.parameters)))}dispatch(e,r,a){const i=this._rctx;this._previouslyBoundDraw.clear();let s=null;const o=this._draws.length;for(let l=0;l<o;l++){const o=a[l];o===s&&o.configuration.transparencyPassType===t.NONE||(i.bindTechnique(o,r,e),s=o);const p=this._draws.data[l],d=p.geometry;i.bindVAO(d.vao),this._previouslyBoundDraw.get(o)!==p.material&&(o.program.bindDraw(p.material,r,e),this._previouslyBoundDraw.set(o,p.material));const c=p.geometryRanges,u=c.length;if(0!==p.indexType){const e=n.get(p.indexType);for(let t=0;t<u;t+=2){const r=c[t],a=c[t+1];i.drawElements(d.primitiveType,a,p.indexType,r*e)}}else for(let e=0;e<u;e+=2){const t=c[e],r=c[e+1];i.drawArrays(d.primitiveType,t,r)}}}prepareSubmit(){this._draws.clear()}finishSubmit(){const e=this._sorting===a.FrontToBack?1:-1;this._draws.sort(((t,r)=>{const a=e*(t.depthSquaredHint-r.depthSquaredHint);return 0!==a?a:t.geometry.vao.byteSize-r.geometry.vao.byteSize}))}get count(){return this._draws.length}}const n=new Map;n.set(r.UNSIGNED_BYTE,1),n.set(r.UNSIGNED_SHORT,2),n.set(r.UNSIGNED_INT,4);export{i as RenderPass,a as RenderPassSorting};
