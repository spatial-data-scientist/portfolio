/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
import{_ as e}from"../../../../chunks/tslib.es6.js";import"../../../../geometry.js";import t from"../../../../analysis/Viewshed.js";import{rad2deg as s}from"../../../../core/mathUtils.js";import{destroyMaybe as i}from"../../../../core/maybe.js";import{watch as o,syncAndInitial as a,sync as l,mapCollection as n}from"../../../../core/reactiveUtils.js";import{property as r}from"../../../../core/accessorSupport/decorators/property.js";import"../../../../core/has.js";import"../../../../core/Logger.js";import"../../../../core/RandomLCG.js";import{subclass as d}from"../../../../core/accessorSupport/decorators/subclass.js";import{create as c}from"../../../../core/libs/gl-matrix-2/factories/mat4f64.js";import{z as h,H as u,s as p,d as m,m as g}from"../../../../chunks/vec32.js";import{create as w}from"../../../../core/libs/gl-matrix-2/factories/vec3f64.js";import{create as _,fromPositionAndNormal as v,projectPoint as b}from"../../../../geometry/support/plane.js";import{ViewshedSubTool as y}from"./ViewshedSubTool.js";import{AnalysisToolBase as f}from"../../../interactive/AnalysisToolBase.js";import{sketchKeys as V}from"../../../interactive/keybindings.js";import{newToolIntersector as T}from"../../../interactive/ToolIntersector.js";import{createScreenPointArrayFromEvent as M}from"../../../support/screenUtils.js";import S from"../../../../geometry/Point.js";var H;let C=H=class extends f{constructor(e){super(e),this.removeIncompleteOnCancel=!1,this.automaticManipulatorSelection=!1,this._stagedViewshed=null,this._stagedViewshedComputedData=null,this._creating=!1,this._selectedManipulator=null,this._selectedManipulatorSubTool=null}initialize(){this._intersector=T(this.view.state.viewingMode);const e=this.analysisViewData.viewshedComputedDataHandles;this.addHandles([o((()=>e.some((e=>e.viewshedComputedData.isValid()))),(e=>{e&&this.finishToolCreation()}),a),o((()=>this._stagedViewshed),(e=>{this._stagedViewshedComputedData=null!=e?this.analysisViewData.viewshedComputedDataHandles.find((t=>t.viewshedComputedData.viewshed===e))?.viewshedComputedData:null}),a),o((()=>this.firstGrabbedManipulator),(e=>{null!=e&&this._selectManipulator(e)}),l),o((()=>this.analysisViewData.visible),(e=>{e||this._selectManipulator(null)})),o((()=>this.view.activeTool),(e=>{e!==this&&null!=e&&this._selectManipulator(null)}))]),this.subToolHandles=n((()=>e),(({viewshedComputedData:e})=>{const t=new y({analysis:this.analysis,analysisViewData:this.analysisViewData,parentTool:this,view:this.view,viewshedComputedData:e});return{subTool:t,remove:()=>{this._selectedManipulatorSubTool===t&&this._selectManipulator(null),t.destroy()}}}))}destroy(){this.subToolHandles=i(this.subToolHandles)}onDeactivate(){this.removeStaged()}get cursor(){return this.creating?"crosshair":null}_selectManipulator(e){const t=this._selectedManipulator;null!=t&&(t.selected=!1,this._selectedManipulator=null,this._selectedManipulatorSubTool?.onManipulatorSelectionChanged(),this._selectedManipulatorSubTool=null),null!=e&&(e.selected=!0,this._selectedManipulator=e,this._selectedManipulatorSubTool=this.subToolHandles.find((t=>t.subTool.hasManipulator(e)))?.subTool,this._selectedManipulatorSubTool?.onManipulatorSelectionChanged())}get selectedViewshed(){return this._selectedManipulatorSubTool?.viewshed}set selectedViewshed(e){this.selectViewshed(e)}get selectedViewshedComputedData(){return this._selectedManipulatorSubTool?.viewshedComputedData}get stagedViewshed(){return this._stagedViewshed}get grabbing(){return this.subToolHandles.some((({subTool:e})=>e.grabbing))}get creating(){return this._creating&&this.active}get placingTarget(){return null!=this._stagedViewshed}createViewsheds(){this._creating=!0}onManipulatorSelectionChanged(){this.subToolHandles.forEach((e=>e.subTool.onManipulatorSelectionChanged()))}onInputEvent(e){switch(e.type){case"immediate-click":this._clickDeselectHandler();break;case"immediate-double-click":this._doubleClickHandler(e);break;case"pointer-move":this._pointerMoveHandler(e);break;case"key-down":V.cancel===e.key?this._cancelKeyHandler(e):V.delete.includes(e.key)&&this._deleteKeyHandler()}}onInputEventAfter(e){if("immediate-click"===e.type)this._clickPlacementHandler(e)}_clickDeselectHandler(){this.hasFocusedManipulators||this._selectManipulator(null)}_clickPlacementHandler(e){if(!this.creating||this.hasFocusedManipulators)return;const s=this._stagedViewshed,i=this._intersectScreen(e,R);if(null!=i){if(null==s){i.mapPoint.z=(i.mapPoint.z??0)+2;const e=new t({observer:i.mapPoint.clone()});this.analysis.viewsheds.add(e),this._stagedViewshed=e,this._updateStagedViewshed(i.scenePoint)}else{this._updateStagedViewshed(i.scenePoint);const e=this._stagedViewshed;this._stagedViewshed=null,this.selectViewshed(e)}e.stopPropagation()}}_doubleClickHandler(e){this.creating&&(this.removeStaged(),this._selectManipulator(null),this._creating=!1,this.view.activeTool=null,e.stopPropagation())}_pointerMoveHandler(e){if(!this.creating||null==this._stagedViewshed)return;const t=this._intersectScreen(e,R);null!=t&&this._updateStagedViewshed(t.scenePoint)}_cancelKeyHandler(e){if(this.creating){if(this.removeStaged())return this._selectManipulator(null),void e.stopPropagation();this._creating=!1}else if(!this.grabbing)return this.selectViewshed(null),void e.stopPropagation()}_deleteKeyHandler(){this.creating&&this.removeStaged(),null!=this.selectedViewshed&&this.analysis.viewsheds.remove(this.selectedViewshed)}_updateStagedViewshed(e){const t=this._stagedViewshed,s=this._stagedViewshedComputedData;if(null==t||null==s)return;const{heading:i,tilt:o,farDistance:a}=D(this.view,s,e);t.farDistance=a,t.tilt=o,t.heading=i}removeStaged(){return null!=this._stagedViewshed&&(this.analysis.viewsheds.remove(this._stagedViewshed),this._stagedViewshed=null,!0)}selectViewshed(e){if(null!=e)for(const s of this.view.tools.items)s!==this&&s instanceof H&&s.selectViewshed(null);const t=this.subToolHandles.find((t=>t.subTool.viewshed===e))?.subTool;this._selectManipulator(t?.discManipulator)}_intersectScreen(e,t){const s=M(e);this.view.sceneIntersectionHelper.intersectToolIntersectorScreen(s,this._intersector);const i=this._intersector.results.min,o=t.scenePoint;if(!i.getIntersectionPoint(o))return null;const a=t.mapPoint;return a.spatialReference=this.view.spatialReference,this.view.renderCoordsHelper.fromRenderCoords(o,a),null==a?null:t}get test(){return{subTools:this.subToolHandles.map((e=>e.subTool.test)),selectedSubTool:this._selectedManipulatorSubTool?.test,stagedViewshed:this._stagedViewshed}}};function D(e,t,i){const o=t.observerRenderSpace,a=h(j,i,o),l=u(a)*t.metersPerUnit,n=e.renderCoordsHelper.basisMatrixAtPosition(o,x),r=p(P,n[8],n[9],n[10]),d=v(o,r,O),c=b(d,i,k),w=h(c,c,o),_=s(m(a,w))*(g(r,a)<0?-1:1)+90,y=p(I,n[4],n[5],n[6]),f=s(m(y,w)),V=p(I,n[0],n[1],n[2]);return{heading:g(w,V)<0?360-f:f,tilt:_,farDistance:l}}e([r({constructOnly:!0})],C.prototype,"view",void 0),e([r()],C.prototype,"analysisViewData",void 0),e([r()],C.prototype,"removeIncompleteOnCancel",void 0),e([r()],C.prototype,"automaticManipulatorSelection",void 0),e([r({constructOnly:!0})],C.prototype,"analysis",void 0),e([r()],C.prototype,"subToolHandles",void 0),e([r()],C.prototype,"_stagedViewshed",void 0),e([r()],C.prototype,"_stagedViewshedComputedData",void 0),e([r()],C.prototype,"_creating",void 0),e([r({readOnly:!0})],C.prototype,"cursor",null),e([r()],C.prototype,"_selectedManipulator",void 0),e([r()],C.prototype,"_selectedManipulatorSubTool",void 0),e([r()],C.prototype,"selectedViewshed",null),e([r()],C.prototype,"selectedViewshedComputedData",null),e([r()],C.prototype,"grabbing",null),e([r()],C.prototype,"creating",null),e([r()],C.prototype,"placingTarget",null),C=H=e([d("esri.views.3d.analysis.Viewshed.ViewshedTool")],C);const j=w(),P=w(),k=w(),I=w(),x=c(),O=_(),R={mapPoint:new S,scenePoint:w()},z=C;export{z as default};
