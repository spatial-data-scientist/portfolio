/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
import{_ as e}from"../../../../chunks/tslib.es6.js";import i from"../../../../core/Accessor.js";import{isSome as t}from"../../../../core/arrayUtils.js";import{cyclicalDegrees as a,Cyclical as s}from"../../../../core/Cyclical.js";import{handlesGroup as n}from"../../../../core/handleUtils.js";import{destroyMaybe as l}from"../../../../core/maybe.js";import{watch as o,syncAndInitial as r,initial as p}from"../../../../core/reactiveUtils.js";import{property as u}from"../../../../core/accessorSupport/decorators/property.js";import"../../../../core/has.js";import"../../../../core/Logger.js";import{subclass as h}from"../../../../core/accessorSupport/decorators/subclass.js";import{z as d,H as c,m as v}from"../../../../chunks/vec32.js";import{create as m}from"../../../../core/libs/gl-matrix-2/factories/vec3f64.js";import{project as f}from"../../../../geometry/projection.js";import{viewingModeFromString as M}from"../../../ViewingMode.js";import{FieldOfViewManipulation as _,isSideHorizontal as w}from"./FieldOfViewManipulation.js";import{ScaleOrientManipulation as b}from"./ScaleOrientManipulation.js";import{scaleOrientMinDistance as g}from"./viewshedToolConfig.js";import{ViewshedObserverManipulator as V}from"./viewshedToolManipulatorUtils.js";import{Settings as O}from"../../interactive/editingTools/settings.js";import{discRadiusSmall as y}from"../../interactive/editingTools/manipulations/config.js";import{MoveManipulation as D}from"../../interactive/editingTools/manipulations/MoveManipulation.js";import{ExtendedLineVisualElement as E}from"../../interactive/visualElements/ExtendedLineVisualElement.js";import{LaserlineVisualElement as H}from"../../interactive/visualElements/LaserlineVisualElement.js";import{RenderOccludedFlag as j}from"../../webgl-engine/lib/Material.js";import{resetProperties as T,dragManipulatedObject as C}from"../../../interactive/dragEventPipeline.js";import{EditGeometryOperations as F}from"../../../interactive/editGeometry/EditGeometryOperations.js";const x=Symbol("dragHandles"),P=Symbol("hideManipulators");let S=class extends i{constructor(e){super(e),this._moveManipulation=null,this._observerManipulator=null,this._fieldOfViewManipulation=null,this._scaleOrientManipulation=null,this._moveHelperVisualElement=null,this._settings=new O({getTheme:()=>this.view.effectiveTheme}),this._grabbing=!1,this.viewshedComputedData=null}initialize(){this._moveManipulation=this._createMoveManipulation(),this._fieldOfViewManipulation=new _({view:this.view,tool:this.parentTool}),this._scaleOrientManipulation=new b({view:this.view,tool:this.parentTool}),this._observerManipulator=new V(this.view,this.parentTool),this._createMoveHelperVisuals(),this.addHandles([o((()=>{const{observer:e}=this;return{observer:e,array:e?.toArray()}}),(({observer:e})=>{null!=e&&(this._moveManipulation.location=e,this._observerManipulator.location=e)}),r),o((()=>{const{viewshedComputedData:e}=this;return{viewshedComputedData:e,observer:e?.observer}}),(({viewshedComputedData:e,observer:i},a)=>{this._grabbing&&i!==a?.observer||(this.removeHandles(x),e?.isValid()&&this.addHandles([this._buildObserverDragPipeline(e),this._buildFOVDragPipeline(e),this._buildScaleOrientDragPipeline(e)].filter(t),x))}),p),o((()=>{const e=this.viewshedComputedData;return e?.isValid()?{viewshedCompData:e,target:e.targetRenderSpace,hFOV:e.horizontalFieldOfView,vFOV:e.verticalFieldOfView}:null}),(e=>{null!=e&&this._fieldOfViewManipulation.updateManipulatorsTransform(e.viewshedCompData)}),p),o((()=>{const e=this.viewshedComputedData;return e?.isValid()?{viewshedCompData:e,hFOV:e.horizontalFieldOfView,vFOV:e.verticalFieldOfView,tilt:e.tilt}:null}),(e=>{null!=e&&this._fieldOfViewManipulation.updateManipulatorVisuals(e.viewshedCompData)}),p),o((()=>this.analysisViewData.visible&&(this.viewshedComputedData?.isValid()??!1)&&!this.parentTool.placingTarget),(e=>this._updateManipulationAvailability(e)),p),o((()=>{const e=this.viewshedComputedData;if(!e?.isValid())return null;const{observer:i,target:t,verticalFieldOfView:a,horizontalFieldOfView:s}=e;return{viewshedCompData:e,observer:i,target:t,verticalFieldOfView:a,horizontalFieldOfView:s}}),(e=>{null!=e&&this._scaleOrientManipulation.updateManipulators(e.viewshedCompData)}),p),o((()=>this.viewshedComputedData?.observerRenderSpace),(e=>{null!=e&&this._updateMoveHelperVisualsLocation(e)}),p)]);const e=e=>{this.addHandles([e.events.on("focus-changed",(()=>this._updateManipulatorVisibility())),e.events.on("grab-changed",(e=>{this._grabbing="start"===e.action}))])};this._forEachManipulator(e)}destroy(){this._moveManipulation=l(this._moveManipulation),this._fieldOfViewManipulation=l(this._fieldOfViewManipulation),this._scaleOrientManipulation=l(this._scaleOrientManipulation),this.parentTool.manipulators.remove(this._observerManipulator),this._observerManipulator=l(this._observerManipulator),this._destroyMoveHelperVisuals()}get viewshed(){return this.viewshedComputedData?.viewshed}get grabbing(){return this._grabbing}get observer(){return this.viewshed?.observer}set observer(e){const i=this.viewshed;null!=i&&(i.observer=e)}get discManipulator(){return this._moveManipulation.xyManipulation.discManipulator}onManipulatorSelectionChanged(){this._updateManipulatorVisibility()}hasManipulator(e){let i=!1;return this._forEachManipulator((t=>{i=i||t===e})),i}_someManipulatorSelected(){return this._moveManipulation.selected||this._fieldOfViewManipulation.selected||this._scaleOrientManipulation.selected}_someManipulatorHovering(){return this._moveManipulation.hovering||this._fieldOfViewManipulation.hovering||this._scaleOrientManipulation.hovering}_createMoveManipulation(){return new D({view:this.view,tool:this.parentTool,snapToScene:!1,xyAvailable:!0,xyAxisAvailable:!0,zAvailable:!0,radius:y})}_buildObserverDragPipeline(e){const i={mode:"absolute-height",offset:0},t=e.observer;return null==t?null:this._moveManipulation.createDragPipeline(((i,t,a,s,n)=>{s=s.next(T(this,["observer"]));const l=e.observer.clone();if(null==l)return{steps:a,cancel:s};const o=F.fromGeometry(l,M(this.view.viewingMode));return{steps:a.next(C({operations:o})).next((e=>(this.observer=f(o.data.geometry,l.spatialReference),e))),cancel:s}}),i,t.spatialReference,void 0)}_buildFOVDragPipeline(e){let i=0,t=0;return this._fieldOfViewManipulation.createDragPipeline(((s,n,l)=>{if(null==e)return{steps:n,cancel:l};const o=e.viewshed;l=l.next(T(e,["horizontalFieldOfView","verticalFieldOfView"]));return{steps:n.next((s=>{"start"===s.action&&(i=e.horizontalFieldOfView,t=e.verticalFieldOfView);const n=s.deltaAngle;let l=0;switch(s.side){case"left":l=i/2-n;break;case"right":l=i/2+n;break;case"top":l=t+2*n;break;case"bottom":l=t-2*n}return w(s.side)?(l=a.normalize(l),l=l>270?0:l>180?180:l,o.horizontalFieldOfView=2*l):o.verticalFieldOfView=l,s})),cancel:l}}),e)}_buildScaleOrientDragPipeline(e){let i=0,t=0;const s=(i,t)=>(a,s,n)=>{if(null==e)return{steps:s,cancel:n};const l=e.viewshed;return n=n.next(T(l,[i])),{steps:s=s.next(t(l,e)),cancel:n}};return n([this._scaleOrientManipulation.createHeadingDragPipeline(s("heading",((i,s)=>s=>("start"===s.action&&(t=e.heading),i.heading=a.normalize(t+s.deltaAngle),s))),e),this._scaleOrientManipulation.createTiltDragPipeline(s("tilt",((t,a)=>a=>{"start"===a.action&&(i=e.tilt);let s=i+a.deltaAngle;return s<-90?s=180:s>270&&(s=0),t.tilt=A.clamp(s),a})),e),this._scaleOrientManipulation.createDistanceDragPipeline(s("farDistance",((e,i)=>t=>{const a=d(z,t.renderEnd,i.observerRenderSpace),s=c(a)*i.metersPerUnit,n=v(a,i.targetDirection)<0?g:s;return e.farDistance=n,t})),e)])}_updateManipulationAvailability(e){this._moveManipulation.available=e,this._fieldOfViewManipulation.available=e,this._scaleOrientManipulation.available=e,this._observerManipulator.available=e}_updateManipulatorVisibility(){const e=this._someManipulatorSelected()||this._someManipulatorHovering()&&null==this.view.activeTool;if(e)this.removeHandles(P);else{const e=[],i=i=>{e.push(i.disableDisplay())};this._forEachManipulator(i),this.addHandles(e,P)}this._updateMoveHelperVisualsVisibility(e)}_forEachManipulator(e){this._moveManipulation.forEachManipulator(e),this._fieldOfViewManipulation.forEachManipulator(e),this._scaleOrientManipulation.forEachManipulator(e),e(this._observerManipulator)}_createMoveHelperVisuals(){this._destroyMoveHelperVisuals();const e=new H({view:this.view,attached:!0,style:{glowWidth:this._settings.visualElements.heightPlane.glowWidth,innerWidth:this._settings.visualElements.heightPlane.innerWidth},isDecoration:!0}),i=new E({view:this.view,extensionType:this._settings.visualElements.zVerticalLine.extensionType,attached:!0,innerWidth:1,writeDepthEnabled:!1,renderOccluded:j.OccludeAndTransparent,isDecoration:!0});this._moveHelperVisualElement={laserline:e,verticalLine:i},this.addHandles([o((()=>this._settings.visualElements.zVerticalLine),(e=>e.apply(i)),r),o((()=>this._settings.visualElements.heightPlane),(i=>i.apply(e)),r)])}_updateMoveHelperVisualsVisibility(e){e=this.analysisViewData.visible&&e;const i=this._moveHelperVisualElement;null!=i&&(i.verticalLine.visible=e,i.laserline.visible=e)}_updateMoveHelperVisualsLocation(e){const i=this._moveHelperVisualElement;if(null==i)return;const{laserline:t,verticalLine:a}=i;t.heightManifoldTarget=e,t.intersectsWorldUpAtLocation=e,null!=e&&a.setStartEndFromWorldDownAtLocation(e)}_destroyMoveHelperVisuals(){const e=this._moveHelperVisualElement;null!=e&&(e.laserline.destroy(),e.verticalLine.destroy(),this._moveHelperVisualElement=null)}get test(){return{moveManipulation:this._moveManipulation,fieldOfViewManipulation:this._fieldOfViewManipulation,scaleOrientManipulation:this._scaleOrientManipulation,moveHelperVisualElements:this._moveHelperVisualElement,viewshedComputedData:this.viewshedComputedData}}};e([u({constructOnly:!0})],S.prototype,"analysis",void 0),e([u({constructOnly:!0})],S.prototype,"analysisViewData",void 0),e([u({constructOnly:!0})],S.prototype,"parentTool",void 0),e([u({constructOnly:!0,nonNullable:!0})],S.prototype,"view",void 0),e([u()],S.prototype,"viewshed",null),e([u()],S.prototype,"_grabbing",void 0),e([u()],S.prototype,"grabbing",null),e([u()],S.prototype,"viewshedComputedData",void 0),e([u()],S.prototype,"observer",null),S=e([h("esri.views.3d.analysis.Viewshed.ViewshedSubTool")],S);const z=m(),A=new s(0,180);export{S as ViewshedSubTool};
