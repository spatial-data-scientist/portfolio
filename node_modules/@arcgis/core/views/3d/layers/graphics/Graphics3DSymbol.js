/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
import{isSome as t}from"../../../../core/arrayUtils.js";import{forEach as e}from"../../../../core/asyncUtils.js";import"../../../../core/has.js";import{onAbortOrThrow as r,throwIfAborted as s}from"../../../../core/promiseUtils.js";import{totalSymbolComplexities as o}from"./defaultSymbolComplexity.js";import{Graphics3DGraphic as a}from"./Graphics3DGraphic.js";import{Graphics3DObject3DGraphicLayer as i}from"./Graphics3DObject3DGraphicLayer.js";import{Graphics3DSymbolLayerCreationContext as n}from"./Graphics3DSymbolCreationContext.js";import{make as l}from"./Graphics3DSymbolLayerFactory.js";import{ApplyRendererDiffResult as y}from"./interfaces.js";import{Loadable as h,LoadStatus as m}from"./Loadable.js";class c extends h{set symbol(t){this._symbol=t,t.symbolLayers.forEach(((e,r)=>{const s=this.symbolLayers[r];null!=s&&(s.symbol=t,s.symbolLayer=e)}))}get symbol(){return this._symbol}constructor(t,e,r){super(e.schedule),this._symbol=t,this._context=e,this._backgroundLayers=r,this._destroyed=!1,this.symbolLayers=new Array,this.referenced=0,this._extentPadding=0}async doLoad(t){let o=this._symbol.symbolLayers;this._extentPadding=0,this._backgroundLayers&&(o=this._backgroundLayers.concat(o));const a=o.length;for(;this.symbolLayers.length<o.length;)this.symbolLayers.push(null);this.symbolLayers.length=o.length;const i=[];for(let e=0;e<a;e++){const s=o.at(e);if(!1===s.enabled)continue;p.renderPriority=1-(1+e)/a,p.renderPriorityStep=1/a,p.ignoreDrivers=s.ignoreDrivers;const n=l(this.symbol,s,this._context,p),y=r(t,(()=>{this.symbolLayers[e]=null,n.destroy()}));y&&i.push(y),this.symbolLayers[e]=n}if(await e(this.symbolLayers,(async(t,e)=>{if(null!=t)try{await t.load(),this._extentPadding+=Math.max(this._extentPadding,t.extentPadding)}catch{this.symbolLayers[e]=null}})),i.forEach((t=>t.remove())),s(t),this.symbolLayers.length&&!this.symbolLayers.some((t=>!!t)))throw new Error}getSymbolLayerSize(t){const e=this.symbolLayers[t];return null!=e?e.getCachedSize():null}get extentPadding(){return this._extentPadding}get symbologySnappingSupported(){return this.symbolLayers.some((t=>t?.queryForSnapping))}createGraphics3DGraphic(t,e){const r=t.graphic,s=this.symbolLayers.map((e=>e?.createGraphics3DGraphic(t)??null)),o=this._context.arcade||this._context.featureExpressionInfoContext?.arcade?.modules||null;return new a(r,e||this,s,t.layer,o)}get complexity(){return o(this.symbolLayers.map((t=>null!=t?t.complexity:null)))}globalPropertyChanged(t,e){const r=this.symbolLayers.length;for(let s=0;s<r;s++){const r=this.symbolLayers[s],o=t=>{const e=t.layers[s];return e instanceof i?e:null};if(null!=r&&!r.globalPropertyChanged(t,e,o))return!1}return!0}applyRendererDiff(t,e){return this.loadStatus!==m.LOADED?y.RecreateSymbol:this.symbolLayers.reduce(((r,s)=>r!==y.RecreateSymbol&&null!=s?Math.min(r,s.applyRendererDiff(t,e)):r),y.FastUpdate)}prepareSymbolPatch(t){if(this.loadStatus===m.FAILED)return;if("partial"!==t.diff.type)return;const e=t.diff.diff;if(!e.symbolLayers||"partial"!==e.symbolLayers.type)return;const r=e.symbolLayers.diff;this.symbolLayers.forEach(((e,s)=>{if(null==e)return;const o=r[s];if(o){const r={diff:o,graphics3DGraphicPatches:[],symbolLayerStatePatches:[]};e.prepareSymbolLayerPatch(r),t.symbolStatePatches.push(...r.symbolLayerStatePatches),r.graphics3DGraphicPatches.length&&t.graphics3DGraphicPatches.push(((t,e)=>{const o=t.layers[s];null!=o&&r.graphics3DGraphicPatches.forEach((t=>t(o,e)))}))}}))}updateGeometry(t,e){return this._updateGeometryOrTransform(t,((t,r)=>t.updateGeometry(r,e)))}updateTransform(t,e,r,s){return this._updateGeometryOrTransform(t,((t,o)=>t.updateTransform(o,e,r,s)))}_updateGeometryOrTransform(t,e){for(let r=0;r<this.symbolLayers.length;r++){const s=this.symbolLayers[r];if(null==s)continue;const o=t.layers[r];if(!o||!e(s,o))return!1}return!0}onRemoveGraphic(t){for(let e=0;e<this.symbolLayers.length;e++){const r=this.symbolLayers[e];if(null==r)continue;const s=t.layers[e];null!=s&&r.onRemoveGraphic(s)}}getFastUpdateStatus(){let t=0,e=0,r=0;return this.symbolLayers.forEach((s=>{null!=s&&(s.loadStatus===m.LOADING?t++:s.isFastUpdatesEnabled()?r++:e++)})),{loading:t,slow:e,fast:r}}async queryForSnapping(e,r,o,a){const i=this.symbolLayers.filter(t).filter((t=>null!=t.queryForSnapping)).map((t=>t.queryForSnapping(e,r,o,a))),n=await Promise.all(i);return s(a),n.flat()}destroy(){if(!this.destroyed){super.destroy();for(const t of this.symbolLayers)null!=t&&t.destroy();this.symbolLayers.length=0,this._destroyed=!0}}get destroyed(){return this._destroyed}}const p=new n;export{c as Graphics3DSymbol};
