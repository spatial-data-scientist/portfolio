/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
import{adjustStaticAGOUrl as e}from"../../../../core/devEnvironmentUtils.js";import{hasScaling as t}from"../../../../core/mathUtils.js";import{normalFromMat4 as r,fromMat4 as o}from"../../../../core/libs/gl-matrix-2/math/mat3.js";import{create as s}from"../../../../core/libs/gl-matrix-2/factories/mat3f64.js";import{invert as i}from"../../../../core/libs/gl-matrix-2/math/mat4.js";import{create as n}from"../../../../core/libs/gl-matrix-2/factories/mat4f64.js";import{ONES as l}from"../../../../core/libs/gl-matrix-2/factories/vec2f64.js";import{h as a,f as u,D as c,l as m,n as f,o as d}from"../../../../chunks/vec32.js";import{create as p}from"../../../../core/libs/gl-matrix-2/factories/vec3f64.js";import{empty as g,expandWithVec3 as x}from"../../../../geometry/support/aaBoundingBox.js";import{newFloatArray as b}from"../../../../geometry/support/FloatArray.js";import{BufferViewVec4f as h,BufferViewVec4u8 as T,BufferViewVec4u16 as y,BufferViewVec3f as w,BufferViewVec3u8 as v,BufferViewVec3u16 as R}from"../../../../geometry/support/buffer/BufferView.js";import{a as j,t as B,n as M,s as S}from"../../../../chunks/vec3.js";import{t as F,s as A}from"../../../../chunks/vec4.js";import{n as L}from"../../../../chunks/vec2.js";import{c as E}from"../../../../chunks/vec33.js";import{c as O}from"../../../../chunks/vec43.js";import{DefaultLoadingContext as I}from"../../glTF/DefaultLoadingContext.js";import{loadGLTF as C}from"../../glTF/loader.js";import{convertPrimitiveToTriangles as k}from"../../glTF/internal/indexUtils.js";import{isEncodedMeshTexture as N}from"../../glTF/internal/resourceUtils.js";import{getTransformMatrix as P}from"../../glTF/internal/TextureTransformUtils.js";import{ProcessedObjectResource as U}from"./ProcessedObjectResource.js";import{load as D,processLoadResult as V}from"./wosrLoader.js";import{NormalType as _}from"../../webgl-engine/core/shaderLibrary/attributes/NormalAttribute.glsl.js";import{Attribute as H}from"../../webgl-engine/lib/Attribute.js";import{AlphaDiscardMode as q,DepthTestFunction as G,CullFaceOptions as W}from"../../webgl-engine/lib/basicInterfaces.js";import{Geometry as $}from"../../webgl-engine/lib/Geometry.js";import{Texture as z}from"../../webgl-engine/lib/Texture.js";import{VertexAttribute as K}from"../../webgl-engine/lib/VertexAttribute.js";import{DefaultMaterial as Q}from"../../webgl-engine/materials/DefaultMaterial.js";import{colorGamma as J}from"../../webgl-engine/materials/DefaultMaterial_COLOR_GAMMA.js";import{defaultEsriSymbologyMRRFactors as X,defaultAdvancedMRRFactors as Y,useSchematicPBR as Z,defaultSchematicMRRFactors as ee}from"../../webgl-engine/materials/pbrUtils.js";async function te(t,r){const o=re(e(t));if("wosr"===o.fileType){const e=await(r.cache?r.cache.loadWOSR(o.url,r):D(o.url,r)),{engineResources:t,referenceBoundingBox:s}=V(e,r);return{lods:t,referenceBoundingBox:s,isEsriSymbolResource:!1,isWosr:!0}}const s=await(r.cache?r.cache.loadGLTF(o.url,r,!!r.usePBR):C(new I(r.streamDataRequester),o.url,r,r.usePBR)),i=s.model.meta?.ESRI_proxyEllipsoid,n=s.meta.isEsriSymbolResource&&null!=i&&"EsriRealisticTreesStyle"===s.meta.ESRI_webstyle;n&&!s.customMeta.esriTreeRendering&&(s.customMeta.esriTreeRendering=!0,ae(s,i));const l=!!r.usePBR,a=s.meta.isEsriSymbolResource?{usePBR:l,isSchematic:!1,treeRendering:n,mrrFactors:[...X]}:{usePBR:l,isSchematic:!1,treeRendering:!1,mrrFactors:[...Y]},u={...r.materialParameters,treeRendering:n},{engineResources:c,referenceBoundingBox:m}=oe(s,a,u,r.skipHighLods&&null==o.specifiedLodIndex?{skipHighLods:!0}:{skipHighLods:!1,singleLodIndex:o.specifiedLodIndex});return{lods:c,referenceBoundingBox:m,isEsriSymbolResource:s.meta.isEsriSymbolResource,isWosr:!1}}function re(e){const t=e.match(/(.*\.(gltf|glb))(\?lod=([0-9]+))?$/);if(t)return{fileType:"gltf",url:t[1],specifiedLodIndex:null!=t[4]?Number(t[4]):null};return e.match(/(.*\.(json|json\.gz))$/)?{fileType:"wosr",url:e,specifiedLodIndex:null}:{fileType:"unknown",url:e,specifiedLodIndex:null}}function oe(e,t,r,o){const s=e.model,i=new Array,n=new Map,l=new Map,a=s.lods.length,u=g();return s.lods.forEach(((e,c)=>{const m=!0===o.skipHighLods&&(a>1&&0===c||a>3&&1===c)||!1===o.skipHighLods&&null!=o.singleLodIndex&&c!==o.singleLodIndex;if(m&&0!==c)return;const f=new U(e.name,e.lodThreshold,[0,0,0]);e.parts.forEach((e=>{const o=m?new Q({}):se(s,e,f,t,r,n,l),{geometry:i,vertexCount:a}=ie(e,null!=o?o:new Q({})),d=i.boundingInfo;null!=d&&0===c&&(x(u,d.bbMin),x(u,d.bbMax)),null!=o&&(f.stageResources.geometries.push(i),f.numberOfVertices+=a)})),m||i.push(f)})),{engineResources:i,referenceBoundingBox:u}}function se(e,t,r,o,s,i,n){const a=t.material+(t.attributes.normal?"_normal":"")+(t.attributes.color?"_color":"")+(t.attributes.texCoord0?"_texCoord0":"")+(t.attributes.tangent?"_tangent":""),u=e.materials.get(t.material),c=null!=t.attributes.texCoord0,m=null!=t.attributes.normal;if(null==u)return null;const f=le(u.alphaMode);if(!i.has(a)){if(c){const t=(t,r=!1)=>{if(null!=t&&!n.has(t)){const o=e.textures.get(t);if(null!=o){const e=o.data;n.set(t,new z(N(e)?e.data:e,{...o.parameters,preMultiplyAlpha:!N(e)&&r,encoding:N(e)&&null!=e.encoding?e.encoding:void 0}))}}};t(u.textureColor,f!==q.Opaque),t(u.textureNormal),t(u.textureOcclusion),t(u.textureEmissive),t(u.textureMetallicRoughness)}const r=u.color[0]**(1/J),d=u.color[1]**(1/J),p=u.color[2]**(1/J),g=u.emissiveFactor[0]**(1/J),x=u.emissiveFactor[1]**(1/J),b=u.emissiveFactor[2]**(1/J),h=null!=u.textureColor&&c?n.get(u.textureColor):null,T=Z({normalTexture:u.textureNormal,metallicRoughnessTexture:u.textureMetallicRoughness,metallicFactor:u.metallicFactor,roughnessFactor:u.roughnessFactor,emissiveTexture:u.textureEmissive,emissiveFactor:u.emissiveFactor,occlusionTexture:u.textureOcclusion}),y=null!=u.normalTextureTransform?.scale?u.normalTextureTransform?.scale:l;i.set(a,new Q({...o,transparent:f===q.Blend,customDepthTest:G.Lequal,textureAlphaMode:f,textureAlphaCutoff:u.alphaCutoff,diffuse:[r,d,p],ambient:[r,d,p],opacity:u.opacity,doubleSided:u.doubleSided,doubleSidedType:"winding-order",cullFace:u.doubleSided?W.None:W.Back,hasVertexColors:!!t.attributes.color,hasVertexTangents:!!t.attributes.tangent,normalType:m?_.Attribute:_.ScreenDerivative,castShadows:!0,receiveShadows:u.receiveShadows,receiveAmbientOcclusion:u.receiveAmbientOcclustion,textureId:null!=h?h.id:void 0,colorMixMode:u.colorMixMode,normalTextureId:null!=u.textureNormal&&c?n.get(u.textureNormal).id:void 0,textureAlphaPremultiplied:null!=h&&!!h.parameters.preMultiplyAlpha,occlusionTextureId:null!=u.textureOcclusion&&c?n.get(u.textureOcclusion).id:void 0,emissiveTextureId:null!=u.textureEmissive&&c?n.get(u.textureEmissive).id:void 0,metallicRoughnessTextureId:null!=u.textureMetallicRoughness&&c?n.get(u.textureMetallicRoughness).id:void 0,emissiveFactor:[g,x,b],mrrFactors:T?[...ee]:[u.metallicFactor,u.roughnessFactor,o.mrrFactors[2]],isSchematic:T,colorTextureTransformMatrix:P(u.colorTextureTransform),normalTextureTransformMatrix:P(u.normalTextureTransform),scale:[y[0],y[1]],occlusionTextureTransformMatrix:P(u.occlusionTextureTransform),emissiveTextureTransformMatrix:P(u.emissiveTextureTransform),metallicRoughnessTextureTransformMatrix:P(u.metallicRoughnessTextureTransform),...s}))}const d=i.get(a);if(r.stageResources.materials.push(d),c){const e=e=>{null!=e&&r.stageResources.textures.push(n.get(e))};e(u.textureColor),e(u.textureNormal),e(u.textureOcclusion),e(u.textureEmissive),e(u.textureMetallicRoughness)}return d}function ie(e,s){const i=e.attributes.position.count,n=k(e.indices||i,e.primitiveType),l=b(3*i),{typedBuffer:a,typedBufferStride:u}=e.attributes.position;j(l,a,e.transform,3,u);const c=[[K.POSITION,new H(l,n,3,!0)]];if(null!=e.attributes.normal){const o=b(3*i),{typedBuffer:s,typedBufferStride:l}=e.attributes.normal;r(ne,e.transform),B(o,s,ne,3,l),t(ne)&&M(o,o),c.push([K.NORMAL,new H(o,n,3,!0)])}if(null!=e.attributes.tangent){const r=b(4*i),{typedBuffer:s,typedBufferStride:l}=e.attributes.tangent;o(ne,e.transform),F(r,s,ne,4,l),t(ne)&&M(r,r,4),c.push([K.TANGENT,new H(r,n,4,!0)])}if(null!=e.attributes.texCoord0){const t=b(2*i),{typedBuffer:r,typedBufferStride:o}=e.attributes.texCoord0;L(t,r,2,o),c.push([K.UV0,new H(t,n,2,!0)])}const m=e.attributes.color;if(null!=m){const t=new Uint8Array(4*i);4===m.elementCount?m instanceof h?A(t,m,255):m instanceof T?O(t,m):m instanceof y&&A(t,m,1/256):(t.fill(255),m instanceof w?S(t,m.typedBuffer,255,4,m.typedBufferStride):e.attributes.color instanceof v?E(t,m.typedBuffer,4,e.attributes.color.typedBufferStride):e.attributes.color instanceof R&&S(t,m.typedBuffer,1/256,4,m.typedBufferStride)),c.push([K.COLOR,new H(t,n,4,!0)])}return{geometry:new $(s,c),vertexCount:i}}const ne=s();function le(e){switch(e){case"BLEND":return q.Blend;case"MASK":return q.Mask;case"OPAQUE":case null:case void 0:return q.Opaque}}function ae(e,t){for(let r=0;r<e.model.lods.length;++r){const o=e.model.lods[r];for(const s of o.parts){const o=s.attributes.normal;if(null==o)return;const l=s.attributes.position,g=l.count,x=p(),b=p(),h=p(),y=new Uint8Array(4*g),v=new Float64Array(3*g),R=i(n(),s.transform);let j=0,B=0;for(let i=0;i<g;i++){l.getVec(i,b),o.getVec(i,x),a(b,b,s.transform),u(h,b,t.center),c(h,h,t.radius);const n=h[2],p=m(h),g=Math.min(.45+.55*p*p,1);c(h,h,t.radius),null!==R&&a(h,h,R),f(h,h),r+1!==e.model.lods.length&&e.model.lods.length>1&&d(h,h,x,n>-1?.2:Math.min(-4*n-3.8,1)),v[j]=h[0],v[j+1]=h[1],v[j+2]=h[2],j+=3,y[B]=255*g,y[B+1]=255*g,y[B+2]=255*g,y[B+3]=255,B+=4}s.attributes.normal=new w(v),s.attributes.color=new T(y)}}}export{te as fetch,oe as gltfToEngineResources,re as parseUrl};
